<!DOCTYPE html>
<html lang="en" color-mode="light">

  <head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  
  <meta name="author" content="Seth Dworman" />
  <meta name="description" content="" />
  
  
  <title>
    
      Automatic Update for Valheim Server 
      
      
      |
    
     Seth&#39;s blog
  </title>

  
    <link rel="apple-touch-icon" href="/images/icons8-espresso-cup-100-newest.png">
    <link rel="icon" href="/images/icons8-espresso-cup-100-newest.png">
  

  <!-- Raleway-Font -->
  <link href="https://fonts.googleapis.com/css?family=Raleway&display=swap" rel="stylesheet">

  <!-- hexo site css -->
  <link rel="stylesheet" href="/css/main.css" />
  <link rel="stylesheet" href="//at.alicdn.com/t/font_1886449_67xjft27j1l.css" />
  <!-- 代码块风格 -->
  

  <!-- jquery3.3.1 -->
  
    <script defer type="text/javascript" src="/plugins/jquery.min.js"></script>
  

  <!-- fancybox -->
  
    <link href="/plugins/jquery.fancybox.min.css" rel="stylesheet">
    <script defer type="text/javascript" src="/plugins/jquery.fancybox.min.js"></script>
  
  
<script src="/js/fancybox.js"></script>


  
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-FG2L3F19SM"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-FG2L3F19SM');
    </script>
  

  

  <script>
    var html = document.documentElement
    const colorMode = localStorage.getItem('color-mode')
    if (colorMode) {
      document.documentElement.setAttribute('color-mode', colorMode)
    }
  </script>
<meta name="generator" content="Hexo 5.4.2"></head>


  <body>
    <div id="app">
      <div class="header">
  <div class="avatar">
    <a href="/">
      <!-- 头像取消懒加载，添加no-lazy -->
      
        <img src="/images/seth-datathon-square2.jpg" alt="">
      
    </a>
    <div class="nickname"><a href="/">sethmachine</a></div>
  </div>
  <div class="navbar">
    <ul>
      
        <li class="nav-item" data-path="/">
          <a href="/">Blog</a>
        </li>
      
        <li class="nav-item" data-path="/about/">
          <a href="/about/">About</a>
        </li>
      
        <li class="nav-item" data-path="/tags/">
          <a href="/tags/">Tags</a>
        </li>
      
    </ul>
  </div>
</div>


<script src="/js/activeNav.js"></script>



      <div class="flex-container">
        <!-- 文章详情页，展示文章具体内容，url形式：https://yoursite/文章标题/ -->
<!-- 同时为「标签tag」，「朋友friend」，「分类categories」，「关于about」页面的承载页面，具体展示取决于page.type -->


  <!-- LaTex Display -->

  
    <script async type="text/javascript" src="/plugins/mathjax/tex-chtml.js"></script>
  
  <script>
    MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']]
      }
    }
  </script>





  <!-- clipboard -->

  
    <script async type="text/javascript" src="/plugins/clipboard.min.js"></script>
  
  
<script src="/js/codeCopy.js"></script>







  

  

  

  
  <!-- 文章内容页 url形式：https://yoursite/文章标题/ -->
  <div class="container post-details" id="post-details">
    <div class="post-content">
      <div class="post-title">Automatic Update for Valheim Server</div>
      <div class="post-attach">
        <span class="post-pubtime">
          <i class="iconfont icon-updatetime mr-10" title="Update time"></i>
          2022-12-08 10:38:15
        </span>
        
              <span class="post-tags">
                <i class="iconfont icon-tags mr-10" title="Tags"></i>
                
                <span class="span--tag mr-8">
                  <a href="/tags/Docker/" title="Docker">
                    #Docker
                  </a>
                </span>
                
                <span class="span--tag mr-8">
                  <a href="/tags/Valheim/" title="Valheim">
                    #Valheim
                  </a>
                </span>
                
                <span class="span--tag mr-8">
                  <a href="/tags/Steam/" title="Steam">
                    #Steam
                  </a>
                </span>
                
                <span class="span--tag mr-8">
                  <a href="/tags/Dedicated-Server/" title="Dedicated Server">
                    #Dedicated Server
                  </a>
                </span>
                
                <span class="span--tag mr-8">
                  <a href="/tags/Bash/" title="Bash">
                    #Bash
                  </a>
                </span>
                
              </span>
          
      </div>
      <div class="markdown-body">
        <p><img src="/2021/05/21/automatic-update-for-valheim-server/automatic-update-for-valheim-server-logo.jpg" alt="Automatic Update for Valheim Server"></p>
<h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p>This guides explains how to set up automatic update for a dedicated Valheim server with Docker.  Automatic update is exciting because it minimizes server downtime as a human no longer needs to manually update and restart the server, giving a true 24/7 server uptime experience.    </p>
<p>This guide assumes you have already successfully set up a dedicated server.  It builds on the previous guide <a href="/2021/02/11/host-valheim-with-docker/" title="Host Valheim with Docker">Host Valheim with Docker</a> that covers the basics of running a dedicated server at home.  I recommend reading through the previous guide if you haven’t already, as this guide will reference many ideas and keywords introduced previously.  </p>
<p>If you’re quite familiar with Valheim servers, Docker, and Bash, feel free to jump straight to using the image I built:</p>
<ul>
<li>Docker Hub: <a target="_blank" rel="noopener" href="https://hub.docker.com/r/sethmachineio/valheim-server">sethmachineio/valheim-server</a></li>
<li>GitHub: <a target="_blank" rel="noopener" href="https://github.com/sethmachine/valheim-server-docker">valheim-server-docker</a></li>
</ul>
<h2 id="Why-automatic-update"><a href="#Why-automatic-update" class="headerlink" title="Why automatic update"></a>Why automatic update</h2><p>The idea behind automatic update is simple: if there’s a newer version of the Valheim server, upgrade the current server to it.  Updating the Valheim server is necessary due to Valheim’s client-server model: whenever the game gets new content, the servers also get updates.  Further, updates to the game are pushed unilaterally–players have no choice whether to update or not.  If there is a version mismatch between a game client and a server, players cannot join the server!  This means there is no way around updating the server.  </p>
<p>The “easy” way to do the update is have the human admin be notified when an update is available.  The human admin needs to shut down the server, perform the update, and then restart the server.  These are all manual steps that have a single point of failure: the human admin needs to be available.  Imagine the admin is sick, loses internet connection, or otherwise is unavailable for a longer period of time; there is the potential for unacceptable downtime for a dedicated server.  </p>
<p>Automatic update further reduces manual administration of the server since no human needs to be involved, allowing it to be closer to a true 24/7 uptime experience.  Valheim is still in its infancy and we can continue to expect a stream of new content and bug fixes that automatic update will handle without friction.  </p>
<p>In summary:</p>
<ul>
<li>New game clients cannot join an outdated server.  To keep the server running 24/7 requires updating it as soon as new content is available.   </li>
<li>Automatic update removes the need for a human administrator to detect the update, stop the server, update the server, and restart it.  This can enable the server to run 24/7 on the latest updates without having to wait for an admin to perform the update.  </li>
</ul>
<h2 id="The-challenge-of-automatic-update"><a href="#The-challenge-of-automatic-update" class="headerlink" title="The challenge of automatic update"></a>The challenge of automatic update</h2><p>OK, so if you’ve gotten this far you may be sold.  Automatic update sounds fantastic!  Unfortunately, the Valheim server itself comes with no automatic update feature.  That means it is up to us to come up with a system that can perform all the steps for automatic update.  This adds additional complexity to our dedicated server software, making it harder to understand, debug, and maintain.  </p>
<p>Another issue is that updating requires stopping the current server.  This can lead to a slew of different problems for players such as:</p>
<ul>
<li>How can players be warned that the server is updating (and therefore that they’ll be kicked off)?</li>
<li>Should players or an admin be able to delay or stop an update?  Imagine players are still on the old client (a new Valheim update was sent out while they are still playing).  The old server will work fine for these players until they update their game client.  </li>
<li>How can players be told the update is complete and the server is back online so they can continue playing instead of manually checking the server list? </li>
</ul>
<p>To keep this automatic update guide simple, we won’t cover how to handle the challenges associated with notifying players about updates and any impact it could have on an ongoing game.  Notifications about server status are very important and merit a separate guide.  </p>
<h2 id="Steps-for-automatic-update"><a href="#Steps-for-automatic-update" class="headerlink" title="Steps for automatic update"></a>Steps for automatic update</h2><p>The idea behind automatic update is simple: update the server whenever a new version is available.  This can be broken down into several steps:</p>
<ol>
<li> Detect that new updates are available and that the server is outdated</li>
<li> Stop the current running server so updates can be performed</li>
<li> Perform the actual update and validate the server is updated</li>
<li> Start up the server again</li>
</ol>
<p>Each of these steps is simple to understand but the implementation of each may not be straightforward.  We will cover each step and see how they can be orchestrated together to build a system for automatic update.   </p>
<h2 id="Environment-for-testing"><a href="#Environment-for-testing" class="headerlink" title="Environment for testing"></a>Environment for testing</h2><p>When setting out to build an automatic update system, it is key verify that it behaves as expected before use on an actual server.  Automatic update requires stopping the server, updating it, and starting it up again.  If any of these operations fail, the server will be unusable until an admin is available to correct the issue.  Thus, it is critical to verify these steps work before adding the automatic update feature to a real Valheim server.  This is often how real world software is tested in order to minimize customer impact when adding new features.  </p>
<p>Verifying that automatic update works is tricky, since (1) we cannot predict when a new update is coming in and (2) a fresh download of the Valheim server with Steamcmd will always yield the latest version.  To verify that our automatic update works, we can use an outdated version of the Valheim server.  If our code is written correctly, then (1) we expect the server to update to the latest version and (2) we are able to play on the updated server.<br>For testing purposes, I’ll be using an outdated copy of the Valheim server (version 0.146.8) so that we can trigger an automatic update.  The image is available here: <a target="_blank" rel="noopener" href="https://hub.docker.com/layers/139144633/sethmachineio/valheim-server/0.146.8/images/sha256-ec5e3c4ed64175c6f6ade8fc4762a8a110d1e2bce31fc7453ada65b78b2c12ce?context=explore">sethmachineio/valheim-server:0.146.8</a>.  </p>
<h3 id="Logging"><a href="#Logging" class="headerlink" title="Logging"></a>Logging</h3><p>The demands of automatic update require orchestrating several different steps: detecting an update, shutting down the server, updating the server, and starting it backup.  In <a href="/2021/02/11/host-valheim-with-docker/" title="the previous guide">the previous guide</a>  we built a simple system: startup the server once and shutdown the server once.  Our new automatic update system can potentially start up, update, and shut down an infinite number of times.  To handle this massive increase in complexity, we will want keep track of the state of automatic update to understand how it is behaving as it runs for real, which will help in debugging any unforeseen issues going forward.  Enter logging, which is exactly what is sounds: keep track of key state about our system as it performs different steps as human readable text.  Previously we had used just <code>echo</code> statements, but these require heavy modification to be of use in our new, more complex system (e.g. timestamps, which function the message came from, etc.).  </p>
<p>For logging we will use <a target="_blank" rel="noopener" href="https://github.com/idelsink/b-log">b-log</a> which runs out of the box with logging levels like <code>INFO</code>, <code>WARN</code>, and <code>ERROR</code>.  </p>
<p>To view these logging statements from a running Docker container, use <code>docker logs &lt;container-name&gt;</code>, e.g. <code>docker logs valheim-server</code>.  It is also possible to save the output to a log file for additional inspection.   </p>
<h3 id="Set-up-outdated-server"><a href="#Set-up-outdated-server" class="headerlink" title="Set up outdated server"></a>Set up outdated server</h3><p>Here is how we can setup an environment to test automatic update:</p>
<ol>
<li><p> Pull down the outdated Valheim server docker image: <code>docker pull sethmachineio/valheim-server:0.146.8</code></p>
</li>
<li><p>Run the Docker image as a named container.  You can make up parameters as we’re only interested in getting the old Valheim server copy:</p>
 <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker run --name=old-valheim -d \</span><br><span class="line">-p 2456:2456/udp -p 2457:2457/udp -p 2458:2458/udp \</span><br><span class="line">-v /Users/sdworman/valheim-data:/home/steam/valheim-data \</span><br><span class="line">--<span class="built_in">env</span> VALHEIM_SERVER_NAME=<span class="string">&quot;sethmachine&quot;</span> \</span><br><span class="line">--<span class="built_in">env</span> VALHEIM_WORLD_NAME=<span class="string">&quot;MadeUpWorld&quot;</span> \</span><br><span class="line">--<span class="built_in">env</span> VALHEIM_PASSWORD=<span class="string">&quot;HardToGuessPassword&quot;</span> \</span><br><span class="line">sethmachineio/valheim-server:0.146.8</span><br></pre></td></tr></table></figure></li>
<li><p> Make a <code>dev</code> directory in order to separate files used only local development: <code>mkdir dev/</code> </p>
</li>
<li><p>Copy all of the Valheim server contents from the running image to your local machine.  </p>
 <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker <span class="built_in">cp</span> old-valheim:/home/steam/valheim-server/ dev/</span><br></pre></td></tr></table></figure></li>
<li><p>The old server files should now be copied over.  Verify with <code>ls dev/valheim-server</code> on your local machine:</p>
 <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">% <span class="built_in">ls</span> dev/valheim-server</span><br><span class="line">LinuxPlayer_s.debug                     linux64                                 start_server_xterm.sh                   valheim_server.x86_64</span><br><span class="line">UnityPlayer.so                          server_exit.drp                         steam_appid.txt                         valheim_server_Data</span><br><span class="line">UnityPlayer_s.debug                     start-valheim-server.sh                 steamapps</span><br><span class="line">Valheim Dedicated Server Manual.pdf     start_server.sh                         steamclient.so </span><br></pre></td></tr></table></figure></li>
<li><p> Stop and delete the old container: <code>docker stop old-valheim &amp;&amp; docker rm old-valheim</code></p>
</li>
<li><p>Write a new Dockerfile that copies over the old server files instead of downloading it from Steam.  This looks nearly identical to the <a target="_blank" rel="noopener" href="https://github.com/sethmachine/valheim-server-docker/blob/main/Dockerfile">Dockerfile from the previous guide</a>.  </p>
 <figure class="highlight dockerfile"><table><tr><td class="code"><pre><span class="line"><span class="keyword">FROM</span> cm2network/steamcmd:latest</span><br><span class="line"></span><br><span class="line"><span class="comment"># need to be ROOT to install new programs</span></span><br><span class="line"><span class="keyword">USER</span> ROOT</span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apt-get update &amp;&amp; apt-get install git -y</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># where Steam is installed</span></span><br><span class="line"><span class="keyword">ENV</span> STEAM_DIR = <span class="string">&quot;/home/steam/Steam&quot;</span></span><br><span class="line"><span class="comment"># where steamcmd is installed</span></span><br><span class="line"><span class="keyword">ENV</span> STEAM_CMD_DIR = <span class="string">&quot;/home/steam/steamcmd&quot;</span></span><br><span class="line"><span class="comment"># where the Valheim server is installed to</span></span><br><span class="line"><span class="keyword">ENV</span> VALHEIM_SERVER_DIR <span class="string">&quot;/home/steam/valheim-server&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># clone the latest b-log from git, remove git to reduce image size, then allow the Steam user to use b-log</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">cd</span> <span class="variable">$&#123;STEAM_DIR&#125;</span> &amp;&amp; git <span class="built_in">clone</span> https://github.com/idelsink/b-log.git &amp;&amp; apt-get remove git -y &amp;&amp; <span class="built_in">chown</span> -R steam:steam b-log/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">USER</span> steam</span><br><span class="line"></span><br><span class="line"><span class="comment"># install the Valheim server</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> --<span class="built_in">chown</span>=steam dev/valheim-server <span class="variable">$&#123;VALHEIM_SERVER_DIR&#125;</span></span></span><br><span class="line"><span class="comment"># RUN ./steamcmd.sh +login anonymous \</span></span><br><span class="line"><span class="comment"># +force_install_dir $VALHEIM_SERVER_DIR \</span></span><br><span class="line"><span class="comment"># +app_update 896660 \</span></span><br><span class="line"><span class="comment"># validate +exit</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># where world data is stored, map this to the host directory where your worlds are stored</span></span><br><span class="line"><span class="comment"># e.g. docker run -v /path/to/host/directory:/home/steam/valheim-data</span></span><br><span class="line"><span class="keyword">ENV</span> VALHEIM_DATA_DIR <span class="string">&quot;/home/steam/valheim-data&quot;</span></span><br><span class="line"><span class="comment"># don&#x27;t change the port unless you know what you are doing</span></span><br><span class="line"><span class="keyword">ENV</span> VALHEIM_PORT <span class="number">2456</span></span><br><span class="line"><span class="comment"># server and world name are truncated after 1st white space</span></span><br><span class="line"><span class="comment"># you must set values to the server and world name otherwise the container will exit immediately</span></span><br><span class="line"><span class="keyword">ENV</span> VALHEIM_SERVER_NAME=<span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">ENV</span> VALHEIM_WORLD_NAME=<span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">ENV</span> VALHEIM_PASSWORD <span class="string">&quot;password&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># the server needs these 3 ports exposed by default</span></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">2456</span>/udp</span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">2457</span>/udp</span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">2458</span>/udp</span><br><span class="line"></span><br><span class="line"><span class="keyword">VOLUME</span><span class="language-bash"> <span class="variable">$&#123;VALHEIM_DATA_DIR&#125;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment"># copy over server start script</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> --<span class="built_in">chown</span>=steam start-valheim-server.sh <span class="variable">$&#123;VALHEIM_SERVER_DIR&#125;</span></span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> <span class="variable">$&#123;VALHEIM_SERVER_DIR&#125;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="language-bash"> [<span class="string">&quot;./start-valheim-server.sh&quot;</span>]</span></span><br></pre></td></tr></table></figure>
<p> Note the “install” command is now just copying over the old Valheim server: <code>COPY --chown=steam dev/valheim-server $&#123;VALHEIM_SERVER_DIR&#125;</code>.  A copy of start script can be found here: <a target="_blank" rel="noopener" href="https://github.com/sethmachine/valheim-server-docker/blob/main/start-valheim-server.sh">start-valheim-server.sh</a>. </p>
</li>
<li><p> Create a new test image as needed: <code>docker build -t old-valheim-server/old-valheim-server -f Dockerfile --no-cache .</code>.  <code>Dockerfile</code> is the name of the Dockerfile in the current directory.  </p>
</li>
</ol>
<p>We will be using this Dockerfile as a basis for writing automatic update and will frequently rebuild it as we add and test additional functionality to support automatic update.  </p>
<h2 id="Detect-server-updates"><a href="#Detect-server-updates" class="headerlink" title="Detect server updates"></a>Detect server updates</h2><h3 id="Find-local-build-ID"><a href="#Find-local-build-ID" class="headerlink" title="Find local build ID"></a>Find local build ID</h3><p> Now we have a way to run an outdated Valheim server, we need to find a way to know there is an update available.  Unfortunately, the Valheim server does not provide any native functionality to do this.  Instead, we will need to examine the server’s build ID.  Steam apps (e.g. the Valheim server) indicate version through a <a target="_blank" rel="noopener" href="https://partner.steamgames.com/doc/store/application/builds">buildid</a> (build ID).  We can view all the build IDs of the Valheim server here: <a target="_blank" rel="noopener" href="https://steamdb.info/app/896660/patchnotes/">Valheim Server builds</a>.  As of April 19, 2021, the latest build ID is 6508109.  As the Valheim server is a Steam app, we can find the build ID by examining its local app manifest file.  </p>
<p> The manifest can be found here in the Valheim server files: <code>valheim-server/steamapps/appmanifest_896660.acf</code>.  Within the Docker container, the full path is <code>/home/steam/valheim-server/steamapps/appmanifest_896660.acf</code>.  A description of the format can be found here: <a target="_blank" rel="noopener" href="https://github.com/leovp/steamfiles/blob/master/docs/acf_overview.rst">ACF Format</a>. Here is what the file looks like: </p>
 <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">% <span class="built_in">cat</span> dev/valheim-server/steamapps/appmanifest_896660.acf </span><br><span class="line"><span class="string">&quot;AppState&quot;</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="string">&quot;appid&quot;</span>         <span class="string">&quot;896660&quot;</span></span><br><span class="line">        <span class="string">&quot;Universe&quot;</span>              <span class="string">&quot;1&quot;</span></span><br><span class="line">        <span class="string">&quot;name&quot;</span>          <span class="string">&quot;Valheim Dedicated Server&quot;</span></span><br><span class="line">        <span class="string">&quot;StateFlags&quot;</span>            <span class="string">&quot;4&quot;</span></span><br><span class="line">        <span class="string">&quot;installdir&quot;</span>            <span class="string">&quot;Valheim dedicated server&quot;</span></span><br><span class="line">        <span class="string">&quot;LastUpdated&quot;</span>           <span class="string">&quot;1616289051&quot;</span></span><br><span class="line">        <span class="string">&quot;UpdateResult&quot;</span>          <span class="string">&quot;0&quot;</span></span><br><span class="line">        <span class="string">&quot;SizeOnDisk&quot;</span>            <span class="string">&quot;1051599543&quot;</span></span><br><span class="line">        <span class="string">&quot;buildid&quot;</span>               <span class="string">&quot;6315977&quot;</span></span><br><span class="line">        <span class="string">&quot;LastOwner&quot;</span>             <span class="string">&quot;76561198275811401&quot;</span></span><br><span class="line">        <span class="string">&quot;BytesToDownload&quot;</span>               <span class="string">&quot;569743664&quot;</span></span><br><span class="line">        <span class="string">&quot;BytesDownloaded&quot;</span>               <span class="string">&quot;569743664&quot;</span></span><br><span class="line">        <span class="string">&quot;BytesToStage&quot;</span>          <span class="string">&quot;1051599543&quot;</span></span><br><span class="line">        <span class="string">&quot;BytesStaged&quot;</span>           <span class="string">&quot;1051599543&quot;</span></span><br><span class="line">        <span class="string">&quot;AutoUpdateBehavior&quot;</span>            <span class="string">&quot;0&quot;</span></span><br><span class="line">        <span class="string">&quot;AllowOtherDownloadsWhileRunning&quot;</span>               <span class="string">&quot;0&quot;</span></span><br><span class="line">        <span class="string">&quot;ScheduledAutoUpdate&quot;</span>           <span class="string">&quot;0&quot;</span></span><br><span class="line">        <span class="string">&quot;InstalledDepots&quot;</span></span><br><span class="line">        &#123;</span><br><span class="line">                <span class="string">&quot;1006&quot;</span></span><br><span class="line">                &#123;</span><br><span class="line">                        <span class="string">&quot;manifest&quot;</span>              <span class="string">&quot;6688153055340488873&quot;</span></span><br><span class="line">                        <span class="string">&quot;size&quot;</span>          <span class="string">&quot;59862244&quot;</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="string">&quot;896661&quot;</span></span><br><span class="line">                &#123;</span><br><span class="line">                        <span class="string">&quot;manifest&quot;</span>              <span class="string">&quot;6588021550109601388&quot;</span></span><br><span class="line">                        <span class="string">&quot;size&quot;</span>          <span class="string">&quot;991737299&quot;</span></span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="string">&quot;UserConfig&quot;</span></span><br><span class="line">        &#123;</span><br><span class="line">        &#125;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>
<p> Of note is the line <code>&quot;buildid&quot;               &quot;6315977&quot;</code> which tells us the build ID of the <em>local</em> Valheim server.  <em>Local</em> here means the copy of the Valheim server we have downloaded already (as opposed to the latest or <em>remote</em> version).   Build ID <a target="_blank" rel="noopener" href="https://steamdb.info/patchnotes/6315977/">6315977</a> means we’re about 3 builds behind, the latest being <a target="_blank" rel="noopener" href="https://steamdb.info/patchnotes/6508109/">6508109</a> (as of April 19th, 2021).  </p>
<p> We will extract the build ID using a text processing tool called <a target="_blank" rel="noopener" href="https://www.pcre.org/">pcregrep</a>.  pcregrep allows writing regular expressions that can match patterns that span multiple lines.  The multiline functionality will be needed later for finding the remote/latest build ID.  Alternative approaches include: (1) Python libaries to parse the ACF format and (2) native Linux <a target="_blank" rel="noopener" href="https://www.gnu.org/software/grep/manual/grep.html">grep</a>.  We won’t use Python in order to minimize our dependency footprint (it can add nearly 1 GB to the Docker image size).  grep is not an option as it does not support multiline pattern matching which will be needed.  </p>
<p> Now to get the local build ID programmatically:</p>
<ol>
<li><p>Modify the Dockerfile so the first 3 lines look like:</p>
  <figure class="highlight dockerfile"><table><tr><td class="code"><pre><span class="line"><span class="keyword">FROM</span> cm2network/steamcmd:latest </span><br><span class="line"></span><br><span class="line"><span class="keyword">USER</span> root</span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apt-get update &amp;&amp; apt-get install pcregrep -y &amp;&amp; apt-get install git -y</span></span><br></pre></td></tr></table></figure>
</li>
<li><p> Re-build the Docker image and run it as a named container, e.g. <code>valheim</code>.  </p>
</li>
<li><p> Enter the running container using <code>docker exec -it valheim /bin/bash</code>.</p>
</li>
<li><p> Enter the directory that contains the manifest, e.g. <code>cd /home/steam/valheim-server/steamapps</code></p>
</li>
<li><p> Verify the app manifests exists, e.g. <code>cat appmanifest_896660.acf</code>.  </p>
</li>
<li><p>Pipe output to <code>pcregrep</code> and look for “buildid”: <code>cat appmanifest_896660.acf | pcregrep &quot;buildid&quot;</code>:</p>
 <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="string">&quot;buildid&quot;</span>               <span class="string">&quot;6315977&quot;</span></span><br></pre></td></tr></table></figure></li>
<li><p> The line with the build ID is now returned.  We only want the numbers, so we need to modify the regular expression further: <code>cat appmanifest_896660.acf | pcregrep -o1 -M &#39;&quot;buildid&quot;.*&quot;([0-9]+)&quot;&#39;</code>.  This should output “6315977”!  </p>
</li>
</ol>
<p>The regular expression essentially says: find the line with build ID and then give me back all the numbers surrounded by quotes.  Don’t worry if the regular expression looks like voodoo; what is important is that we now have a reliable way to get the local build ID!  </p>
<p>Now we can reliably find the build ID of our local Valheim server.  If we can find the the latest (remote) build ID and compare this to our local build ID, we can know whether the server needs to be updated (i.e. the build IDs do not match).  </p>
<h3 id="Find-remote-build-ID"><a href="#Find-remote-build-ID" class="headerlink" title="Find remote build ID"></a>Find remote build ID</h3><p>Fortunately, Steamcmd provides a few methods to query Steam about the latest build IDs of a Steam app.  <code>+app_info_update</code> provides the most recent “app info”, which will contain the latest build ID for the Valheim server.  <code>+app_info_print</code> will dump this information to standard output (stdout) from which the remote build ID can be extracted.  For more details on the command line options, see <a target="_blank" rel="noopener" href="https://developer.valvesoftware.com/wiki/Command_Line_Options#SteamCMD">Steamcmd Command Line Options</a>.  </p>
<p>Within the Docker container, the following command should return the latest info for the Valheim server: <code>/bin/bash /home/steam/steamcmd/steamcmd.sh +login anonymous +app_info_update 1 +app_info_print 896660 +quit &gt; valheim-app-info</code>.  Note I’ve saved the output to a local file for further examination.  Recall that 896600 is the Steam app ID for the Valheim server.  You should see the following output, which is quite verbose (I cut off the parts about Steam updating):</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="string">&quot;896660&quot;</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="string">&quot;common&quot;</span></span><br><span class="line">        &#123;</span><br><span class="line">                <span class="string">&quot;name&quot;</span>          <span class="string">&quot;Valheim Dedicated Server&quot;</span></span><br><span class="line">                <span class="string">&quot;type&quot;</span>          <span class="string">&quot;Tool&quot;</span></span><br><span class="line">                <span class="string">&quot;parent&quot;</span>                <span class="string">&quot;892970&quot;</span></span><br><span class="line">                <span class="string">&quot;oslist&quot;</span>                <span class="string">&quot;windows,linux&quot;</span></span><br><span class="line">                <span class="string">&quot;osarch&quot;</span>                <span class="string">&quot;&quot;</span></span><br><span class="line">                <span class="string">&quot;icon&quot;</span>          <span class="string">&quot;1aab0586723c8578c7990ced7d443568649d0df2&quot;</span></span><br><span class="line">                <span class="string">&quot;logo&quot;</span>          <span class="string">&quot;233d73a1c963515ee4a9b59507bc093d85a4e2dc&quot;</span></span><br><span class="line">                <span class="string">&quot;logo_small&quot;</span>            <span class="string">&quot;233d73a1c963515ee4a9b59507bc093d85a4e2dc_thumb&quot;</span></span><br><span class="line">                <span class="string">&quot;clienticon&quot;</span>            <span class="string">&quot;c55a6b50b170ac6ed56cf90521273c30dccb5f12&quot;</span></span><br><span class="line">                <span class="string">&quot;clienttga&quot;</span>             <span class="string">&quot;35e067b9efc8d03a9f1cdfb087fac4b970a48daf&quot;</span></span><br><span class="line">                <span class="string">&quot;ReleaseState&quot;</span>          <span class="string">&quot;released&quot;</span></span><br><span class="line">                <span class="string">&quot;associations&quot;</span></span><br><span class="line">                &#123;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="string">&quot;gameid&quot;</span>                <span class="string">&quot;896660&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="string">&quot;config&quot;</span></span><br><span class="line">        &#123;</span><br><span class="line">                <span class="string">&quot;installdir&quot;</span>            <span class="string">&quot;Valheim dedicated server&quot;</span></span><br><span class="line">                <span class="string">&quot;launch&quot;</span></span><br><span class="line">                &#123;</span><br><span class="line">                        <span class="string">&quot;0&quot;</span></span><br><span class="line">                        &#123;</span><br><span class="line">                                <span class="string">&quot;executable&quot;</span>            <span class="string">&quot;start_server_xterm.sh&quot;</span></span><br><span class="line">                                <span class="string">&quot;type&quot;</span>          <span class="string">&quot;server&quot;</span></span><br><span class="line">                                <span class="string">&quot;config&quot;</span></span><br><span class="line">                                &#123;</span><br><span class="line">                                        <span class="string">&quot;oslist&quot;</span>                <span class="string">&quot;linux&quot;</span></span><br><span class="line">                                &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="string">&quot;1&quot;</span></span><br><span class="line">                        &#123;</span><br><span class="line">                                <span class="string">&quot;executable&quot;</span>            <span class="string">&quot;start_headless_server.bat&quot;</span></span><br><span class="line">                                <span class="string">&quot;type&quot;</span>          <span class="string">&quot;server&quot;</span></span><br><span class="line">                                <span class="string">&quot;config&quot;</span></span><br><span class="line">                                &#123;</span><br><span class="line">                                        <span class="string">&quot;oslist&quot;</span>                <span class="string">&quot;windows&quot;</span></span><br><span class="line">                                &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="string">&quot;depots&quot;</span></span><br><span class="line">        &#123;</span><br><span class="line">                <span class="string">&quot;1004&quot;</span></span><br><span class="line">                &#123;</span><br><span class="line">                        <span class="string">&quot;name&quot;</span>          <span class="string">&quot;Steamworks SDK Redist (WIN32)&quot;</span></span><br><span class="line">                        <span class="string">&quot;config&quot;</span></span><br><span class="line">                        &#123;</span><br><span class="line">                                <span class="string">&quot;oslist&quot;</span>                <span class="string">&quot;windows&quot;</span></span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="string">&quot;manifests&quot;</span></span><br><span class="line">                        &#123;</span><br><span class="line">                                <span class="string">&quot;public&quot;</span>                <span class="string">&quot;6473168357831043306&quot;</span></span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="string">&quot;maxsize&quot;</span>               <span class="string">&quot;39546856&quot;</span></span><br><span class="line">                        <span class="string">&quot;depotfromapp&quot;</span>          <span class="string">&quot;1007&quot;</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="string">&quot;1005&quot;</span></span><br><span class="line">                &#123;</span><br><span class="line">                        <span class="string">&quot;name&quot;</span>          <span class="string">&quot;Steamworks SDK Redist (OSX32)&quot;</span></span><br><span class="line">                        <span class="string">&quot;config&quot;</span></span><br><span class="line">                        &#123;</span><br><span class="line">                                <span class="string">&quot;oslist&quot;</span>                <span class="string">&quot;macos&quot;</span></span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="string">&quot;manifests&quot;</span></span><br><span class="line">                        &#123;</span><br><span class="line">                                <span class="string">&quot;public&quot;</span>                <span class="string">&quot;2135359612286175146&quot;</span></span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="string">&quot;depotfromapp&quot;</span>          <span class="string">&quot;1007&quot;</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="string">&quot;1006&quot;</span></span><br><span class="line">                &#123;</span><br><span class="line">                        <span class="string">&quot;name&quot;</span>          <span class="string">&quot;Steamworks SDK Redist (LINUX32)&quot;</span></span><br><span class="line">                        <span class="string">&quot;config&quot;</span></span><br><span class="line">                        &#123;</span><br><span class="line">                                <span class="string">&quot;oslist&quot;</span>                <span class="string">&quot;linux&quot;</span></span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="string">&quot;manifests&quot;</span></span><br><span class="line">                        &#123;</span><br><span class="line">                                <span class="string">&quot;public&quot;</span>                <span class="string">&quot;6688153055340488873&quot;</span></span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="string">&quot;maxsize&quot;</span>               <span class="string">&quot;59862244&quot;</span></span><br><span class="line">                        <span class="string">&quot;depotfromapp&quot;</span>          <span class="string">&quot;1007&quot;</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="string">&quot;896661&quot;</span></span><br><span class="line">                &#123;</span><br><span class="line">                        <span class="string">&quot;name&quot;</span>          <span class="string">&quot;Valheim dedicated server Linux&quot;</span></span><br><span class="line">                        <span class="string">&quot;config&quot;</span></span><br><span class="line">                        &#123;</span><br><span class="line">                                <span class="string">&quot;oslist&quot;</span>                <span class="string">&quot;linux&quot;</span></span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="string">&quot;manifests&quot;</span></span><br><span class="line">                        &#123;</span><br><span class="line">                                <span class="string">&quot;public&quot;</span>                <span class="string">&quot;7912728285894485280&quot;</span></span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="string">&quot;maxsize&quot;</span>               <span class="string">&quot;991429535&quot;</span></span><br><span class="line">                        <span class="string">&quot;encryptedmanifests&quot;</span></span><br><span class="line">                        &#123;</span><br><span class="line">                                <span class="string">&quot;experimental&quot;</span></span><br><span class="line">                                &#123;</span><br><span class="line">                                        <span class="string">&quot;encrypted_gid_2&quot;</span>               <span class="string">&quot;6D9E1220765544EA3B7DC02D088CDD6F&quot;</span></span><br><span class="line">                                        <span class="string">&quot;encrypted_size_2&quot;</span>              <span class="string">&quot;4F7078B30DF0F9538945B47354BD7DE9&quot;</span></span><br><span class="line">                                &#125;</span><br><span class="line">                                <span class="string">&quot;unstable&quot;</span></span><br><span class="line">                                &#123;</span><br><span class="line">                                        <span class="string">&quot;encrypted_gid_2&quot;</span>               <span class="string">&quot;BA8AACD688214C6BA994553BA96CB84F&quot;</span></span><br><span class="line">                                        <span class="string">&quot;encrypted_size_2&quot;</span>              <span class="string">&quot;E0DC3506113023BDCFD913C511E06C1F&quot;</span></span><br><span class="line">                                &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="string">&quot;896662&quot;</span></span><br><span class="line">                &#123;</span><br><span class="line">                        <span class="string">&quot;name&quot;</span>          <span class="string">&quot;Valheim dedicated server Windows&quot;</span></span><br><span class="line">                        <span class="string">&quot;config&quot;</span></span><br><span class="line">                        &#123;</span><br><span class="line">                                <span class="string">&quot;oslist&quot;</span>                <span class="string">&quot;windows&quot;</span></span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="string">&quot;manifests&quot;</span></span><br><span class="line">                        &#123;</span><br><span class="line">                                <span class="string">&quot;public&quot;</span>                <span class="string">&quot;2464500753503578968&quot;</span></span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="string">&quot;maxsize&quot;</span>               <span class="string">&quot;983808497&quot;</span></span><br><span class="line">                        <span class="string">&quot;encryptedmanifests&quot;</span></span><br><span class="line">                        &#123;</span><br><span class="line">                                <span class="string">&quot;experimental&quot;</span></span><br><span class="line">                                &#123;</span><br><span class="line">                                        <span class="string">&quot;encrypted_gid_2&quot;</span>               <span class="string">&quot;293E21DD740054EB79AEE3F34C8D9A48&quot;</span></span><br><span class="line">                                        <span class="string">&quot;encrypted_size_2&quot;</span>              <span class="string">&quot;C37E100649B0C392D6D76A141F3BA994&quot;</span></span><br><span class="line">                                &#125;</span><br><span class="line">                                <span class="string">&quot;unstable&quot;</span></span><br><span class="line">                                &#123;</span><br><span class="line">                                        <span class="string">&quot;encrypted_gid_2&quot;</span>               <span class="string">&quot;C7C4577FDF7CDED20056D854E77C11E8&quot;</span></span><br><span class="line">                                        <span class="string">&quot;encrypted_size_2&quot;</span>              <span class="string">&quot;8BD953AE12BCF2C3472F0725D682E037&quot;</span></span><br><span class="line">                                &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="string">&quot;branches&quot;</span></span><br><span class="line">                &#123;</span><br><span class="line">                        <span class="string">&quot;public&quot;</span></span><br><span class="line">                        &#123;</span><br><span class="line">                                <span class="string">&quot;buildid&quot;</span>               <span class="string">&quot;6287700&quot;</span></span><br><span class="line">                                <span class="string">&quot;timeupdated&quot;</span>           <span class="string">&quot;1614242525&quot;</span></span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="string">&quot;experimental&quot;</span></span><br><span class="line">                        &#123;</span><br><span class="line">                                <span class="string">&quot;buildid&quot;</span>               <span class="string">&quot;6294553&quot;</span></span><br><span class="line">                                <span class="string">&quot;description&quot;</span>           <span class="string">&quot;Experimental version of Valheim&quot;</span></span><br><span class="line">                                <span class="string">&quot;pwdrequired&quot;</span>           <span class="string">&quot;1&quot;</span></span><br><span class="line">                                <span class="string">&quot;timeupdated&quot;</span>           <span class="string">&quot;1614271566&quot;</span></span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="string">&quot;unstable&quot;</span></span><br><span class="line">                        &#123;</span><br><span class="line">                                <span class="string">&quot;buildid&quot;</span>               <span class="string">&quot;6295625&quot;</span></span><br><span class="line">                                <span class="string">&quot;description&quot;</span>           <span class="string">&quot;Unstable test version of valheim&quot;</span></span><br><span class="line">                                <span class="string">&quot;pwdrequired&quot;</span>           <span class="string">&quot;1&quot;</span></span><br><span class="line">                                <span class="string">&quot;timeupdated&quot;</span>           <span class="string">&quot;1614285732&quot;</span></span><br><span class="line">                        &#125;</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Of interest is the line starting with “branches” followed by “public”.  The “buildid” under “public” should contain the latest build ID:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="string">&quot;branches&quot;</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="string">&quot;public&quot;</span></span><br><span class="line">        &#123;</span><br><span class="line">                <span class="string">&quot;buildid&quot;</span>               <span class="string">&quot;6287700&quot;</span></span><br><span class="line">                <span class="string">&quot;timeupdated&quot;</span>           <span class="string">&quot;1614242525&quot;</span></span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<p>In this case it contains an even more outdated build ID <a target="_blank" rel="noopener" href="https://steamdb.info/patchnotes/6287700/">6287700</a>.  Running <code>cat valheim-app-info | grep &quot;6508109&quot;</code> doesn’t seem to yield anything either (6508109 is the latest build ID as of April 19th, 2021).  </p>
<p>It turns out Steam caches the app info of all installed apps.  When Steamcmd requests updated app info, it will first look at the local cache.  If the cache doesn’t exist, only then will it ask Steam for the latest app info.  In the Docker container, the cached app info (for all Steam apps installed, not just Valheim) can be found at <code>/home/steam/Steam/appcache/appinfo.vdf</code>.  Let’s delete <code>appinfo.vdf</code> and then re-run the command:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">rm</span> /home/steam/Steam/appcache/appinfo.vdf</span><br><span class="line">/home/steam/steamcmd/steamcmd.sh +login anonymous +app_info_update 1 +app_info_print 896660 +quit &gt; valheim-app-info </span><br></pre></td></tr></table></figure>

<p>Now look for the latest build ID: <code>cat valheim-app-info | grep &quot;6508109&quot;</code>.  This should yield the following output:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="string">&quot;buildid&quot;</span>               <span class="string">&quot;6508109&quot;</span></span><br><span class="line"><span class="string">&quot;buildid&quot;</span>               <span class="string">&quot;6508109&quot;</span></span><br></pre></td></tr></table></figure>

<p>The relevant section of the output now looks like:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="string">&quot;branches&quot;</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="string">&quot;public&quot;</span></span><br><span class="line">        &#123;</span><br><span class="line">                <span class="string">&quot;buildid&quot;</span>               <span class="string">&quot;6508109&quot;</span></span><br><span class="line">                <span class="string">&quot;timeupdated&quot;</span>           <span class="string">&quot;1618836460&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>To extract the latest build ID we will use regular expressions again.  This time the regular expression will need to span multiple lines (we want the “buildid” inside “public” and not any other “buildid” lines).  As an aside, the actual output format is called <a target="_blank" rel="noopener" href="https://developer.valvesoftware.com/wiki/KeyValues">VDF (Valve Key Files Format)</a>.  Unfortunately, there is no Linux package to parse VDF (though Python libraries do exist, e.g. <a target="_blank" rel="noopener" href="https://github.com/ValvePython/vdf">ValvePython</a>).   </p>
<p>Here is what the regular expression looks like that pulls out the public build ID:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cat</span> valheim-app-info | pcregrep -o1 -M <span class="string">&#x27;&quot;branches&quot;.*\n*.*&#123;\n*.*&quot;public&quot;.*\n*.*&#123;.*\n*.*&quot;buildid&quot;.*&quot;([0-9]+)&quot;&#x27;</span></span><br></pre></td></tr></table></figure>

<p>This should output the latest build ID 6508109!  </p>
<h3 id="Compare-build-IDs"><a href="#Compare-build-IDs" class="headerlink" title="Compare build IDs"></a>Compare build IDs</h3><p>It is now possible to extract the local build ID (version of the Valheim server currently being run) and the remote build ID (latest version of the Valheim server).  These two build IDs can be compared to determine if the server has to be updated.  There’s a lot to keep track of, so it makes sense to begin organizing our automatic update code into different script files.  Below is what I’ve come up with for a 1st iteration of checking if the server needs to be updated.  The file is named <code>update-valheim-server.sh</code>:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/usr/bin/env bash</span></span><br><span class="line"><span class="comment"># Provides functions to update to a newer Valheim server automatically</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># This is where the app manifest is that stores the build ID of the local Valheim server</span></span><br><span class="line">VALHEIM_SERVER_APP_MANIFEST=<span class="string">&quot;<span class="variable">$VALHEIM_SERVER_DIR</span>/steamapps/appmanifest_896660.acf&quot;</span></span><br><span class="line"><span class="comment"># This is where the local/current build ID is stored</span></span><br><span class="line">VALHEIM_SERVER_LOCAL_BUILD_ID=<span class="string">&quot;&quot;</span></span><br><span class="line"><span class="comment"># This is what Steam reports is the latest build ID</span></span><br><span class="line">VALHEIM_SERVER_REMOTE_BUILD_ID=<span class="string">&quot;&quot;</span></span><br><span class="line"><span class="comment"># Steam caches all app infos (contain build IDs); need to delete this file to get latest remote build IDs</span></span><br><span class="line">STEAM_CACHED_APP_INFO=<span class="string">&quot;<span class="variable">$STEAM_DIR</span>/appcache/appinfo.vdf&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">findAndSetLocalValheimServerBuildId</span></span>()&#123;</span><br><span class="line">    <span class="comment"># Finds the buildId from the Valheim server&#x27;s local app manifest</span></span><br><span class="line">    <span class="comment"># Check if there was a previous local build ID so we can see if anything changed</span></span><br><span class="line">    <span class="built_in">local</span> previousLocalBuildId=<span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> [[ ! -z <span class="string">&quot;<span class="variable">$&#123;VALHEIM_SERVER_LOCAL_BUILD_ID&#125;</span>&quot;</span> ]]</span><br><span class="line">    <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">local</span> previousLocalBuildId=<span class="variable">$VALHEIM_SERVER_LOCAL_BUILD_ID</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">    VALHEIM_SERVER_LOCAL_BUILD_ID=$(<span class="built_in">cat</span> <span class="variable">$&#123;VALHEIM_SERVER_APP_MANIFEST&#125;</span> | pcregrep -o1 -M <span class="string">&#x27;&quot;buildid&quot;.*&quot;([0-9]+)&quot;&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> [[ ! -z <span class="string">&quot;<span class="variable">$&#123;previousLocalBuildId&#125;</span>&quot;</span> ]] &amp;&amp; [[ <span class="variable">$&#123;previousLocalBuildId&#125;</span> != <span class="variable">$&#123;VALHEIM_SERVER_LOCAL_BUILD_ID&#125;</span> ]]</span><br><span class="line">    <span class="keyword">then</span></span><br><span class="line">        INFO <span class="string">&quot;The local build ID was updated from <span class="variable">$previousLocalBuildId</span> to <span class="variable">$VALHEIM_SERVER_LOCAL_BUILD_ID</span>&quot;</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        INFO <span class="string">&quot;The local build ID is <span class="variable">$VALHEIM_SERVER_LOCAL_BUILD_ID</span>&quot;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">findAndSetRemoteValheimServerBuildId</span></span>()&#123;</span><br><span class="line">    <span class="comment"># Finds the latest build ID from Steam</span></span><br><span class="line">    <span class="comment"># Delete the cached app info so the latest build ID is fetched from Steam</span></span><br><span class="line">    <span class="keyword">if</span> [[ -f <span class="string">&quot;<span class="variable">$&#123;STEAM_CACHED_APP_INFO&#125;</span>&quot;</span> ]]</span><br><span class="line">    <span class="keyword">then</span></span><br><span class="line">        INFO <span class="string">&quot;Deleting cached app info: <span class="variable">$STEAM_CACHED_APP_INFO</span>&quot;</span></span><br><span class="line">        <span class="built_in">rm</span> <span class="variable">$STEAM_CACHED_APP_INFO</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># First update the app info get the latest build IDs from the Steam remote</span></span><br><span class="line">    INFO <span class="string">&quot;Querying the remote server for the latest build ID for the Valheim server&quot;</span></span><br><span class="line">    <span class="built_in">local</span> appInfo=$(/bin/bash <span class="variable">$STEAMCMD_DIR</span>/steamcmd.sh +login anonymous +app_info_update 1 +app_info_print 896660 +quit)</span><br><span class="line">    <span class="comment"># Use a regex that looks for the build ID under the public branch</span></span><br><span class="line">    <span class="comment"># <span class="doctag">TODO:</span> use a VDF parser, as the regex will easily break if the line order changes</span></span><br><span class="line">    <span class="comment">#                    &quot;branches&quot;</span></span><br><span class="line">    <span class="comment">#                &#123;</span></span><br><span class="line">    <span class="comment">#                        &quot;public&quot;</span></span><br><span class="line">    <span class="comment">#                        &#123;</span></span><br><span class="line">    <span class="comment">#                                &quot;buildid&quot;               &quot;6437354&quot;</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    VALHEIM_SERVER_REMOTE_BUILD_ID=$(<span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$appInfo</span>&quot;</span> | pcregrep -o1 -M <span class="string">&#x27;&quot;branches&quot;.*\n*.*&#123;\n*.*&quot;public&quot;.*\n*.*&#123;.*\n*.*&quot;buildid&quot;.*&quot;([0-9]+)&quot;&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    INFO <span class="string">&quot;The remote server build ID is <span class="variable">$VALHEIM_SERVER_REMOTE_BUILD_ID</span>&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Note that the script references environment variables defined in both the Dockerfile and the original <code>start-valheim-server.sh</code>, and also defines new ones that keep track of local build ID (<code>VALHEIM_SERVER_LOCAL_BUILD_ID</code>), remote build ID (<code>VALHEIM_SERVER_REMOTE_BUILD_ID</code>), the Valheim server app manifest (<code>VALHEIM_SERVER_APP_MANIFEST</code>), and Steam’s app info cache (<code>STEAM_CACHED_APP_INFO</code>).  </p>
<h2 id="The-update-loop"><a href="#The-update-loop" class="headerlink" title="The update loop"></a>The update loop</h2><p>In the previous section we were able to find the local build ID and the remote build ID of the Valheim server.  When the local build ID and the remote build ID are not the same, it means our local Valheim server needs to be updated.  Ideally we would want to update as soon as the remote build ID changed.  However, there’s no magical way to know that the remote build ID has changed other than by running <code>findAndSetRemoteValheimServerBuildId</code> over and over again (as an aside, <a href="findAndSetRemoteValheimServerBuildId">SteamWebPipes</a> would allow for listening for new builds but it is far too complex to cover here).  This means we will need some mechanism to periodically query for the remote build ID and then compare to the local build ID while the Valheim server is running.  </p>
<p>This is the update loop, which every so often will need to query Steam to find the latest build ID and compare to the build ID of the current server.  The update loop needs to run forever and will only terminate if the Docker container itself is stopped.  In Bash, the loop might start to look like this:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="keyword">while</span> <span class="literal">true</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">    INFO <span class="string">&quot;Sleeping for <span class="variable">$VALHEIM_SERVER_AUTO_UPDATE_FREQUENCY</span> before checking for Valheim server update&quot;</span></span><br><span class="line">    <span class="built_in">sleep</span> <span class="variable">$VALHEIM_SERVER_AUTO_UPDATE_FREQUENCY</span></span><br><span class="line">    <span class="comment"># Check if the Valheim server needs to be updated, and if so update it</span></span><br><span class="line">    <span class="comment"># Need to stop the Valheim server and then restart it afterwards</span></span><br><span class="line">    INFO <span class="string">&quot;Checking to see if the Valheim server needs to be updated&quot;</span></span><br><span class="line">    findAndSetLocalValheimServerBuildId</span><br><span class="line">    findAndSetRemoteValheimServerBuildId</span><br><span class="line">    <span class="keyword">if</span> [[ <span class="string">&quot;<span class="variable">$VALHEIM_SERVER_LOCAL_BUILD_ID</span>&quot;</span> = <span class="string">&quot;<span class="variable">$VALHEIM_SERVER_REMOTE_BUILD_ID</span>&quot;</span> ]]</span><br><span class="line">    <span class="keyword">then</span></span><br><span class="line">        INFO <span class="string">&quot;The Valheim server is already up to date with build ID <span class="variable">$VALHEIM_SERVER_LOCAL_BUILD_ID</span>&quot;</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        INFO <span class="string">&quot;Updating the Valheim server from <span class="variable">$VALHEIM_SERVER_LOCAL_BUILD_ID</span> (old) to <span class="variable">$VALHEIM_SERVER_REMOTE_BUILD_ID</span> (new)&quot;</span></span><br><span class="line">        shutdownValheimServer</span><br><span class="line">        updateValheimServer</span><br><span class="line">        findAndSetLocalValheimServerBuildId</span><br><span class="line">        assertLocalBuildIsLatest</span><br><span class="line">        startValheimServer</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<p>Some important details:</p>
<ul>
<li><code>$VALHEIM_SERVER_AUTO_UPDATE_FREQUENCY</code> controls how often the update is checked for</li>
<li><a target="_blank" rel="noopener" href="https://man7.org/linux/man-pages/man1/sleep.1.html">sleep</a> pauses the process for the specified duration, e.g. <code>sleep 30s</code> would sleep for 30 seconds before continuing to execute code.  Note that this means the update loop and the Valheim server must necessarily run in different processes–checking for an update should not impact what the server is doing and vice versa.</li>
<li><code>$VALHEIM_SERVER_LOCAL_BUILD_ID</code>, <code>$VALHEIM_SERVER_LOCAL_BUILD_ID</code> variables keep track of what the local and remote build IDs are at all times</li>
<li><code>shutdownValheimServer</code>, <code>updateValheimServer</code>, <code>assertLocalBuildIsLatest</code> and <code>startValheimServer</code> are all functions that we will have implement later.  </li>
</ul>
<p>In regard to <code>$VALHEIM_SERVER_AUTO_UPDATE_FREQUENCY</code>, what duration should be chosen? A very short value, e.g. 30 seconds, will waste a lot of resources just to confirm the server is up to date (it is unlikely an update comes out every 30 seconds) and Steam could potentially throttle or block our request.  A longer duration, e.g. 2 hours, risks having the server unusable for up to 2 hours if an update has been pushed out to clients already.  For a heavily used server, a lower value such as 5, 10 or 15 minutes may be best.  The frequency chosen is the absolute maximum amount of time a server would not be joinable from a newer game client.  It is best to use short durations like 5s for locally debugging and confirming that automatic updating (as we are doing in this guide).  The auto update frequency will be an additional parameter that can be customized at runtime when launching the server rather than hardcoded.  </p>
<p>We will now implement the functions from above that we had left undefined.  Where possible, we will abstract each function to its own script file to logically organize the automatic update system.  </p>
<h3 id="start-valheim-server-sh"><a href="#start-valheim-server-sh" class="headerlink" title="start-valheim-server.sh"></a>start-valheim-server.sh</h3><p>This script defines the <code>startValheimServer</code> function.  It also creates the <code>VALHEIM_SERVER_PID</code> variable that keeps track of the process ID of the server.  The process ID allows to shut down the server without losing data.  </p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/usr/bin/env bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Starts the Valheim server</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Keep track of the Valheim server process ID to shut it down later</span></span><br><span class="line">VALHEIM_SERVER_PID=<span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">startValheimServer</span></span>()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">export</span> templdpath=<span class="variable">$LD_LIBRARY_PATH</span></span><br><span class="line">    <span class="built_in">export</span> LD_LIBRARY_PATH=./linux64:<span class="variable">$LD_LIBRARY_PATH</span></span><br><span class="line">    <span class="built_in">export</span> SteamAppId=892970</span><br><span class="line"></span><br><span class="line">    INFO <span class="string">&quot;Starting the Valheim server&quot;</span></span><br><span class="line">    INFO <span class="string">&quot;LD_LIBRARY_PATH: <span class="variable">$LD_LIBRARY_PATH</span>&quot;</span></span><br><span class="line"></span><br><span class="line">    INFO <span class="string">&quot;Valheim port is: <span class="variable">$VALHEIM_PORT</span>&quot;</span></span><br><span class="line">    INFO <span class="string">&quot;Valheim server name is: <span class="variable">$VALHEIM_SERVER_NAME</span>&quot;</span></span><br><span class="line">    INFO <span class="string">&quot;Valheim world name is: <span class="variable">$VALHEIM_WORLD_NAME</span>&quot;</span></span><br><span class="line">    <span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$&#123;VALHEIM_SERVER_PUBLIC&#125;</span>&quot;</span> = 0 ]</span><br><span class="line">    <span class="keyword">then</span></span><br><span class="line">        WARN <span class="string">&quot;The Valheim server is not set to public.  It will not show up in the server list.  Players must join via IP address instead&quot;</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        INFO <span class="string">&quot;The Valheim server is set to public visibility.  It will be visible in the server list.  Players will still need to enter the password to join&quot;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">cd</span> <span class="variable">$VALHEIM_SERVER_DIR</span></span><br><span class="line">    <span class="comment"># start the server as a background process to get its PID (&quot;&amp;&quot; at end of command)</span></span><br><span class="line">    <span class="comment"># &quot;&amp;&gt;&gt;&quot; means append all stdout and stderr to the log file</span></span><br><span class="line">    ./valheim_server.x86_64 -name <span class="variable">$VALHEIM_SERVER_NAME</span> \</span><br><span class="line">    -port <span class="variable">$VALHEIM_PORT</span> \</span><br><span class="line">    -world <span class="variable">$VALHEIM_WORLD_NAME</span> \</span><br><span class="line">    -password <span class="variable">$VALHEIM_PASSWORD</span> \</span><br><span class="line">    -public <span class="variable">$VALHEIM_SERVER_PUBLIC</span> \</span><br><span class="line">    -savedir <span class="variable">$VALHEIM_DATA_DIR</span> &amp;&gt;&gt; <span class="string">&quot;/home/steam/valheim-data/<span class="variable">$VALHEIM_WORLD_NAME</span>-logs.txt&quot;</span> &amp;</span><br><span class="line">    VALHEIM_SERVER_PID=$!</span><br><span class="line">    INFO <span class="string">&quot;Valheim server PID is: <span class="variable">$VALHEIM_SERVER_PID</span>&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Some important details:</p>
<ul>
<li>This is more or less a copy paste of <code>start-valheim-server</code> script in the previous guide</li>
<li>the <code>&amp;</code> operator at the end a command means to launch that process in the background</li>
<li>the <code>$!</code> operator provides the process ID (pid) of the last process launched in the background (in this case, the Valheim server process)</li>
<li><code>VALHEIM_SERVER_PUBLIC</code> is a new parameter from recent updates that controls whether the server is visible in the join list.  </li>
</ul>
<h3 id="shutdown-valheim-server-sh"><a href="#shutdown-valheim-server-sh" class="headerlink" title="shutdown-valheim-server.sh"></a>shutdown-valheim-server.sh</h3><p>This script defines the <code>shutdownValheimServer</code> function that shuts down the Valheim server process (not necessarily the Docker container).  Note that it references <code>VALHEIM_SERVER_PID</code> from the <code>start-valheim-server.sh</code> script.  There is an additional function <code>shutdownValheimServerAndExit</code> which shuts down the Valheim server <strong>and</strong> exits the Docker container.  When the server is shut down just for an update, we don’t want to exit the container and should use <code>shutdownValheimServer</code>.  If the Docker container itself is requested to stop, e.g. <code>docker stop valheim-server</code>, then <code>shutdownValheimServerAndExit</code> should be run.  </p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/usr/bin/env bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># docker sends a SIGTERM and then SIGKILL to the main process</span></span><br><span class="line"><span class="comment"># Valheim needs a SIGINT (CTRL+C) to terminate properly</span></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">shutdownValheimServerAndExit</span></span>()</span><br><span class="line">&#123;</span><br><span class="line">    WARN <span class="string">&quot;Shutting down the Valheim server.  PID is: <span class="variable">$VALHEIM_SERVER_PID</span>&quot;</span></span><br><span class="line">    <span class="comment"># send a SIGINT to shut down the Valheim server gracefully</span></span><br><span class="line">    <span class="built_in">kill</span> -2 <span class="variable">$VALHEIM_SERVER_PID</span></span><br><span class="line">    <span class="comment"># wait for Valheim to terminate before shutting down the container</span></span><br><span class="line">    <span class="built_in">wait</span> <span class="variable">$VALHEIM_SERVER_PID</span></span><br><span class="line">    <span class="built_in">exit</span> 0</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">shutdownValheimServer</span></span>()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"># Shut down the Valheim server without exiting the current process</span></span><br><span class="line">    WARN <span class="string">&quot;Shutting down the Valheim server.  PID is: <span class="variable">$VALHEIM_SERVER_PID</span>&quot;</span></span><br><span class="line">    <span class="built_in">kill</span> -2 <span class="variable">$VALHEIM_SERVER_PID</span></span><br><span class="line">    <span class="built_in">wait</span> <span class="variable">$VALHEIM_SERVER_PID</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Some important details:</p>
<ul>
<li>use <code>shutdownValheimServerAndExit</code> when stopping the whole Docker container</li>
<li>use <code>shutdownValheimServer</code> when stopping the Valheim server for an update (and intending to start it again when the update is finished)</li>
<li><code>kill -2</code> sends a <code>SIGINT</code> interrupt signal to the Valheim server (equivalent to CTRL+C), which triggers it to shutdown correctly (no loss of data).  </li>
</ul>
<h3 id="update-valheim-server-sh"><a href="#update-valheim-server-sh" class="headerlink" title="update-valheim-server.sh"></a>update-valheim-server.sh</h3><p>This is a continuation of update script that we wrote in <a href="#Putting-it-together">Detect Server Updates</a> which finds the local and remote build IDs.  Let’s expand it further to include update loop and the update logic.  </p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/usr/bin/env bash</span></span><br><span class="line"><span class="comment"># Provides functions to update to a newer Valheim server automatically</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># This is where the app manifest is that stores the build ID of the local Valheim server</span></span><br><span class="line">VALHEIM_SERVER_APP_MANIFEST=<span class="string">&quot;<span class="variable">$VALHEIM_SERVER_DIR</span>/steamapps/appmanifest_896660.acf&quot;</span></span><br><span class="line"><span class="comment"># This is where the local/current build ID is stored</span></span><br><span class="line">VALHEIM_SERVER_LOCAL_BUILD_ID=<span class="string">&quot;&quot;</span></span><br><span class="line"><span class="comment"># This is what Steam reports is the latest build ID</span></span><br><span class="line">VALHEIM_SERVER_REMOTE_BUILD_ID=<span class="string">&quot;&quot;</span></span><br><span class="line"><span class="comment"># Steam caches all app infos (contain build IDs); need to delete this file to get latest remote build IDs</span></span><br><span class="line">STEAM_CACHED_APP_INFO=<span class="string">&quot;<span class="variable">$STEAM_DIR</span>/appcache/appinfo.vdf&quot;</span></span><br><span class="line"><span class="comment"># The PID of the loop that periodically checks whether to update the Valheim server</span></span><br><span class="line">VALHEIM_SERVER_UPDATE_LOOP_PID=<span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">findAndSetLocalValheimServerBuildId</span></span>()&#123;</span><br><span class="line">    <span class="comment"># Finds the buildId from the Valheim server&#x27;s local app manifest</span></span><br><span class="line">    <span class="comment"># Check if there was a previous local build ID so we can see if anything changed</span></span><br><span class="line">    <span class="built_in">local</span> previousLocalBuildId=<span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> [[ ! -z <span class="string">&quot;<span class="variable">$&#123;VALHEIM_SERVER_LOCAL_BUILD_ID&#125;</span>&quot;</span> ]]</span><br><span class="line">    <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">local</span> previousLocalBuildId=<span class="variable">$VALHEIM_SERVER_LOCAL_BUILD_ID</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">    VALHEIM_SERVER_LOCAL_BUILD_ID=$(<span class="built_in">cat</span> <span class="variable">$&#123;VALHEIM_SERVER_APP_MANIFEST&#125;</span> | pcregrep -o1 -M <span class="string">&#x27;&quot;buildid&quot;.*&quot;([0-9]+)&quot;&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> [[ ! -z <span class="string">&quot;<span class="variable">$&#123;previousLocalBuildId&#125;</span>&quot;</span> ]] &amp;&amp; [[ <span class="variable">$&#123;previousLocalBuildId&#125;</span> != <span class="variable">$&#123;VALHEIM_SERVER_LOCAL_BUILD_ID&#125;</span> ]]</span><br><span class="line">    <span class="keyword">then</span></span><br><span class="line">        INFO <span class="string">&quot;The local build ID was updated from <span class="variable">$previousLocalBuildId</span> to <span class="variable">$VALHEIM_SERVER_LOCAL_BUILD_ID</span>&quot;</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        INFO <span class="string">&quot;The local build ID is <span class="variable">$VALHEIM_SERVER_LOCAL_BUILD_ID</span>&quot;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">findAndSetRemoteValheimServerBuildId</span></span>()&#123;</span><br><span class="line">    <span class="comment"># Finds the latest build ID from Steam</span></span><br><span class="line">    <span class="comment"># Delete the cached app info so the latest build ID is fetched from Steam</span></span><br><span class="line">    <span class="keyword">if</span> [[ -f <span class="string">&quot;<span class="variable">$&#123;STEAM_CACHED_APP_INFO&#125;</span>&quot;</span> ]]</span><br><span class="line">    <span class="keyword">then</span></span><br><span class="line">        INFO <span class="string">&quot;Deleting cached app info: <span class="variable">$STEAM_CACHED_APP_INFO</span>&quot;</span></span><br><span class="line">        <span class="built_in">rm</span> <span class="variable">$STEAM_CACHED_APP_INFO</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># First update the app info get the latest build IDs from the Steam remote</span></span><br><span class="line">    INFO <span class="string">&quot;Querying the remote server for the latest build ID for the Valheim server&quot;</span></span><br><span class="line">    <span class="built_in">local</span> appInfo=$(/bin/bash <span class="variable">$STEAMCMD_DIR</span>/steamcmd.sh +login anonymous +app_info_update 1 +app_info_print 896660 +quit)</span><br><span class="line">    <span class="comment"># Use a regex that looks for the build ID under the public branch</span></span><br><span class="line">    <span class="comment"># <span class="doctag">TODO:</span> use a VDF parser, as the regex will easily break if the line order changes</span></span><br><span class="line">    <span class="comment">#                    &quot;branches&quot;</span></span><br><span class="line">    <span class="comment">#                &#123;</span></span><br><span class="line">    <span class="comment">#                        &quot;public&quot;</span></span><br><span class="line">    <span class="comment">#                        &#123;</span></span><br><span class="line">    <span class="comment">#                                &quot;buildid&quot;               &quot;6437354&quot;</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    VALHEIM_SERVER_REMOTE_BUILD_ID=$(<span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$appInfo</span>&quot;</span> | pcregrep -o1 -M <span class="string">&#x27;&quot;branches&quot;.*\n*.*&#123;\n*.*&quot;public&quot;.*\n*.*&#123;.*\n*.*&quot;buildid&quot;.*&quot;([0-9]+)&quot;&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    INFO <span class="string">&quot;The remote server build ID is <span class="variable">$VALHEIM_SERVER_REMOTE_BUILD_ID</span>&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">assertLocalBuildIsLatest</span></span>()&#123;</span><br><span class="line">    <span class="keyword">if</span> [[ <span class="variable">$&#123;VALHEIM_SERVER_LOCAL_BUILD_ID&#125;</span> != <span class="variable">$&#123;VALHEIM_SERVER_REMOTE_BUILD_ID&#125;</span> ]]</span><br><span class="line">    <span class="keyword">then</span></span><br><span class="line">        ERROR <span class="string">&quot;The local build differs from the remote build after updating.  Local build ID: <span class="variable">$VALHEIM_SERVER_LOCAL_BUILD_ID</span>.  Remote build ID: <span class="variable">$VALHEIM_SERVER_REMOTE_BUILD_ID</span>&quot;</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        INFO <span class="string">&quot;The local build ID is the same as the latest remote build ID&quot;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">updateValheimServer</span></span>()&#123;</span><br><span class="line">    INFO <span class="string">&quot;Updating the Valheim server&quot;</span></span><br><span class="line">    /bin/bash <span class="variable">$STEAMCMD_DIR</span>/steamcmd.sh +login anonymous +force_install_dir <span class="variable">$VALHEIM_SERVER_DIR</span> +app_update <span class="variable">$VALHEIM_SERVER_APP_ID</span> +quit</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">updateValheimServerIfNewerBuildExists</span></span>()&#123;</span><br><span class="line">    <span class="comment"># Only call this function before the first time the server ever starts up</span></span><br><span class="line">    INFO <span class="string">&quot;Checking to see if the Valheim server needs to be updated&quot;</span></span><br><span class="line">    findAndSetLocalValheimServerBuildId</span><br><span class="line">    findAndSetRemoteValheimServerBuildId</span><br><span class="line">    <span class="keyword">if</span> [[ <span class="string">&quot;<span class="variable">$VALHEIM_SERVER_LOCAL_BUILD_ID</span>&quot;</span> = <span class="string">&quot;<span class="variable">$VALHEIM_SERVER_REMOTE_BUILD_ID</span>&quot;</span> ]]</span><br><span class="line">    <span class="keyword">then</span></span><br><span class="line">        INFO <span class="string">&quot;The Valheim server is already up to date with build ID <span class="variable">$VALHEIM_SERVER_LOCAL_BUILD_ID</span>&quot;</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        updateValheimServer</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">checkForAndUpdateValheimServer</span></span>()&#123;</span><br><span class="line">    <span class="comment"># Check if the Valheim server needs to be updated, and if so update it</span></span><br><span class="line">    <span class="comment"># Need to stop the Valheim server and then restart it afterwards</span></span><br><span class="line">    INFO <span class="string">&quot;Checking to see if the Valheim server needs to be updated&quot;</span></span><br><span class="line">    findAndSetLocalValheimServerBuildId</span><br><span class="line">    findAndSetRemoteValheimServerBuildId</span><br><span class="line">    <span class="keyword">if</span> [[ <span class="string">&quot;<span class="variable">$VALHEIM_SERVER_LOCAL_BUILD_ID</span>&quot;</span> = <span class="string">&quot;<span class="variable">$VALHEIM_SERVER_REMOTE_BUILD_ID</span>&quot;</span> ]]</span><br><span class="line">    <span class="keyword">then</span></span><br><span class="line">        INFO <span class="string">&quot;The Valheim server is already up to date with build ID <span class="variable">$VALHEIM_SERVER_LOCAL_BUILD_ID</span>&quot;</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        INFO <span class="string">&quot;Updating the Valheim server from <span class="variable">$VALHEIM_SERVER_LOCAL_BUILD_ID</span> (old) to <span class="variable">$VALHEIM_SERVER_REMOTE_BUILD_ID</span> (new)&quot;</span></span><br><span class="line">        shutdownValheimServer</span><br><span class="line">        updateValheimServer</span><br><span class="line">        findAndSetLocalValheimServerBuildId</span><br><span class="line">        assertLocalBuildIsLatest</span><br><span class="line">        startValheimServer</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">startUpdateLoop</span></span>()&#123;</span><br><span class="line">    <span class="built_in">trap</span> <span class="string">&#x27;shutdownValheimServerAndExit&#x27;</span> SIGTERM</span><br><span class="line">    startValheimServer</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">true</span></span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">        INFO <span class="string">&quot;Sleeping for <span class="variable">$VALHEIM_SERVER_AUTO_UPDATE_FREQUENCY</span> before checking for Valheim server update&quot;</span></span><br><span class="line">        <span class="built_in">sleep</span> <span class="variable">$VALHEIM_SERVER_AUTO_UPDATE_FREQUENCY</span> &amp;</span><br><span class="line">        sleep_pid=$!</span><br><span class="line">        <span class="built_in">wait</span> <span class="variable">$sleep_pid</span></span><br><span class="line">        checkForAndUpdateValheimServer</span><br><span class="line">    <span class="keyword">done</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Some important details:</p>
<ul>
<li><code>assertLocalBuildIsLatest</code> checks to see that the local and remote build IDs are the same after an update. If this is not true, then something has gone wrong and this will alert us in an error log statement.  </li>
<li><code>updateValheimServer</code> runs the Steamcmd command needed to update the server to the latest version.  </li>
<li><code>updateValheimServerIfNewerBuildExists</code> updates the Valheim server on startup so that whenever a stopped container is resumed (e.g. <code>docker start valheim-server</code>) it is updated without going through the update loop.  This function is only meant to run once when the container starts and never again.  </li>
<li><code>checkForAndUpdateValheimServer</code> gets the latest remote build ID, compares it to the local build ID, and if they are different, performs the update.  This involves stopping the Valheim server (<code>shutdownValheimServer</code>), updating it (<code>updateValheimServer</code>), and then starting it again (<code>startValheimServer</code>).  </li>
<li><code>startUpdateLoop</code> runs forever and executes <code>checkForAndUpdateValheimServer</code> at the frequency dictated by <code>$VALHEIM_SERVER_AUTO_UPDATE_FREQUENCY</code>.  If the value were 30m, then the loop would check for an update every 30 minutes.  </li>
<li><code>trap &#39;shutdownValheimServerAndExit&#39; SIGTERM</code> intercepts any SIGTERM signals and then requests the Valheim server to stop in order to shut down without data loss (e.g. the container is stopped via <code>docker stop valheim-server</code>).  </li>
<li><code>wait $sleep_pid</code> allows the sleep process to be interrupted by an interrupt signal, i.e. when the Docker container is stopped (<code>docker stop valheim-server</code>).  Without this, the sleep would not terminate and the Valheim server would force killed, potentially resulting in loss of data.</li>
</ul>
<h3 id="valheim-server-entrypoint-sh"><a href="#valheim-server-entrypoint-sh" class="headerlink" title="valheim-server-entrypoint.sh"></a>valheim-server-entrypoint.sh</h3><p>To handle the different runtime parameters and actually kick off the Valheim server and update loop, we will use an entrypoint script.  The entrypoint will also allow a user to disable the automatic update feature if they wish to manually control updates (perhaps running a legacy server, etc.).  </p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/usr/bin/env bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Provides nicely formatting logging</span></span><br><span class="line"><span class="comment"># See: https://github.com/idelsink/b-log</span></span><br><span class="line"><span class="built_in">source</span> <span class="string">&quot;<span class="variable">$STEAM_DIR</span>/b-log/b-log.sh&quot;</span></span><br><span class="line">LOG_LEVEL_ALL <span class="comment"># All log levels are visible</span></span><br><span class="line"><span class="comment"># The entry point script parses runtime parameters and kicks off the Valheim server</span></span><br><span class="line"><span class="comment"># This script must be executed from the same directory as all the other scripts.</span></span><br><span class="line"><span class="built_in">source</span> start-valheim-server.sh</span><br><span class="line"><span class="built_in">source</span> update-valheim-server.sh</span><br><span class="line"><span class="built_in">source</span> shutdown-valheim-server.sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># server name and world name need to be defined at runtime</span></span><br><span class="line"><span class="keyword">if</span> [ -z <span class="string">&quot;<span class="variable">$&#123;VALHEIM_SERVER_NAME&#125;</span>&quot;</span> ]</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">    FATAL <span class="string">&quot;Please set the VALHEIM_SERVER_NAME property.  E.g. use --env VALHEIM_SERVER_NAME=\&quot;My Server Name\&quot;&quot;</span></span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ -z <span class="string">&quot;<span class="variable">$&#123;VALHEIM_WORLD_NAME&#125;</span>&quot;</span> ]</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">    FATAL <span class="string">&quot;Please set the VALHEIM_WORLD_NAME property.  E.g. use --env VALHEIM_WORLD_NAME=\&quot;AWholeNewWorld\&quot;&quot;</span></span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$&#123;VALHEIM_SERVER_UPDATE_ON_START_UP&#125;</span>&quot;</span> = 1 ]</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">    INFO <span class="string">&quot;Attempting one time update of the Valheim server on start up&quot;</span></span><br><span class="line">    updateValheimServerIfNewerBuildExists</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">terminateUpdateLoop</span></span>()&#123;</span><br><span class="line">    INFO <span class="string">&quot;Terminating the update loop.  PID is <span class="variable">$VALHEIM_SERVER_UPDATE_LOOP_PID</span>&quot;</span></span><br><span class="line">    <span class="comment"># -15 is equivalent to SIGTERM</span></span><br><span class="line">    <span class="built_in">kill</span> -15 <span class="variable">$VALHEIM_SERVER_UPDATE_LOOP_PID</span></span><br><span class="line">    <span class="built_in">wait</span> <span class="variable">$VALHEIM_SERVER_UPDATE_LOOP_PID</span></span><br><span class="line">    <span class="built_in">exit</span> 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$&#123;VALHEIM_SERVER_AUTO_UPDATE&#125;</span>&quot;</span> = 0 ]</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">    <span class="comment"># Handle starting and shutting down server normally if no auto update</span></span><br><span class="line">    <span class="comment"># catch Docker&#x27;s SIGTERM, then send a SIGINT to the Valheim server process</span></span><br><span class="line">    <span class="built_in">trap</span> <span class="string">&#x27;shutdownValheimServerAndExit&#x27;</span> SIGTERM</span><br><span class="line">    startValheimServer</span><br><span class="line">    <span class="comment"># since the server is run in the background, this is needed to keep the main process from exiting</span></span><br><span class="line">    <span class="keyword">while</span> <span class="built_in">wait</span> <span class="variable">$VALHEIM_SERVER_PID</span>; [ $? != 0 ]; <span class="keyword">do</span> <span class="literal">true</span>; <span class="keyword">done</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    WARN <span class="string">&quot;Experimental auto update is enabled.  The server will automatically update and restart when a new version is detected&quot;</span></span><br><span class="line">    INFO <span class="string">&quot;Updates to the server will be checked every <span class="variable">$VALHEIM_SERVER_AUTO_UPDATE_FREQUENCY</span>&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">trap</span> <span class="string">&#x27;terminateUpdateLoop&#x27;</span> SIGTERM</span><br><span class="line">    startUpdateLoop &amp;</span><br><span class="line">    VALHEIM_SERVER_UPDATE_LOOP_PID=$!</span><br><span class="line">    INFO <span class="string">&quot;Valheim server update loop PID is: <span class="variable">$VALHEIM_SERVER_UPDATE_LOOP_PID</span>&quot;</span></span><br><span class="line">    <span class="keyword">while</span> <span class="built_in">wait</span> <span class="variable">$VALHEIM_SERVER_UPDATE_LOOP_PID</span>; [[ <span class="string">&quot;<span class="variable">$&#123;VALHEIM_SERVER_UPDATE_LOOP_PID&#125;</span>&quot;</span> != 0 ]]; <span class="keyword">do</span> <span class="literal">true</span>; <span class="keyword">done</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure>

<p>Some important details:</p>
<ul>
<li>the <code>source</code> command effectively imports all the variables and functions of another script, so they can be re-used in the entrypoint and all of its child processes.  </li>
<li><code>VALHEIM_SERVER_UPDATE_ON_START_UP</code> is a runtime parameter that controls whether to update the server whenever starting the container for the first time rather than waiting for the update loop to detect an update.</li>
<li><code>VALHEIM_SERVER_AUTO_UPDATE</code> enables the auto update feature; if set to 0 then the container will simply run the Valheim server at its current version.  Any other value will enable auto update.  Some users may wish to disable auto update if they are running a legacy server or want full control of updates.  </li>
<li><code>terminateUpdateLoop</code> handles stopping the update loop if the container is stopped, e.g. <code>docker stop valheim-server</code>.  It handles the SIGTERM signal from Docker and then redirects it to update loop process, which causes it to execute <code>shutdownValheimServerAndExit</code>.</li>
</ul>
<h3 id="How-it-all-works"><a href="#How-it-all-works" class="headerlink" title="How it all works"></a>How it all works</h3><p>The organization of the scripts is key to making the automatic update process function correctly.  In this case, there are at least 4 different processes at work within the Docker container that are running all the time:</p>
<ul>
<li>The entry point process, which Docker executes when it starts (i.e. <code>valheim-server-entrypoint.sh</code>)</li>
<li>The update loop (from <code>startUpdateLoop</code>)</li>
<li>The sleep process (the pause before checking for an update)</li>
<li>The Valheim server</li>
</ul>
<p>In Bash, a process is only aware of its immediate child processes.  The update loop process is an immediate child of the entry point.  The sleep process and the Valheim server are immediate children of the update loop.  This is why <code>startValheimServer</code> is done in the update loop rather than in the entry point script.  If Valheim was instead started in the entry point, then the update loop would be unable to stop the server (<code>VALHEIM_SERVER_PID</code> would resolve to an empty string).  However, when automatic update is disabled, we do start Valheim in the entry point, as it is simply meant to run forever and never be stopped within the container.  </p>
<p>This process hierarchy is illustrated in how the container is stopped with automatic update:</p>
<p><img src="/2021/05/21/automatic-update-for-valheim-server/valheim-auto-update-shutdown-diagram.png" alt="Valheim Dedicated Server with Docker"></p>
<p>When the container is stopped, Docker sends a SIGTERM signal to the entry point process.  In the entry point, the signal is trapped with <code>trap &#39;terminateUpdateLoop&#39; SIGTERM</code>.  This intercept’s the SIGTERM and executes the code in <code>terminateUpdateLoop</code>.  The function sends a SIGTERM to the update loop process via <code>kill -15 $VALHEIM_SERVER_UPDATE_LOOP_PID</code>.  The update loop traps this SIGTERM as well via <code>trap &#39;shutdownValheimServerAndExit&#39; SIGTERM</code>.  The method <code>shutdownValheimServerAndExit</code> sends a SIGINT to the Valheim server and then exits with 0.  </p>
<h3 id="Updated-Dockerfile"><a href="#Updated-Dockerfile" class="headerlink" title="Updated Dockerfile"></a>Updated Dockerfile</h3><p>We now need to update the Dockerfile to use these new scripts and create the new parameters that control how automatic update works.  Here is what our updated Dockerfile should look like:</p>
<figure class="highlight dockerfile"><table><tr><td class="code"><pre><span class="line"><span class="keyword">FROM</span> cm2network/steamcmd:latest</span><br><span class="line"></span><br><span class="line"><span class="keyword">USER</span> root</span><br><span class="line"><span class="comment"># Install PCREGREP (http://www.pcre.org/) to extract build IDs from the VDF format</span></span><br><span class="line"><span class="comment"># PCREGREP allows for writing easy to understand regular expressions that can span multiple lines</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apt-get update &amp;&amp; apt-get install pcregrep -y &amp;&amp; apt-get install -y procps &amp;&amp; apt-get install git -y</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># where Steam is installed</span></span><br><span class="line"><span class="keyword">ENV</span> STEAM_DIR <span class="string">&quot;/home/steam/Steam&quot;</span></span><br><span class="line"><span class="comment"># where steamcmd is installed</span></span><br><span class="line"><span class="keyword">ENV</span> STEAMCMD_DIR <span class="string">&quot;/home/steam/steamcmd&quot;</span></span><br><span class="line"><span class="comment"># where the Valheim server is installed to</span></span><br><span class="line"><span class="keyword">ENV</span> VALHEIM_SERVER_DIR <span class="string">&quot;/home/steam/valheim-server&quot;</span></span><br><span class="line"><span class="comment"># the Steam app ID that uniquely identifies the server</span></span><br><span class="line"><span class="keyword">ENV</span> VALHEIM_SERVER_APP_ID <span class="number">896660</span></span><br><span class="line"><span class="comment"># 1 enables a one time check to update the Valheim server whenever it is first started</span></span><br><span class="line"><span class="keyword">ENV</span> VALHEIM_SERVER_UPDATE_ON_START_UP <span class="number">1</span></span><br><span class="line"><span class="comment"># 1 enables auto update; set to 0 to disable auto update</span></span><br><span class="line"><span class="keyword">ENV</span> VALHEIM_SERVER_AUTO_UPDATE <span class="number">1</span></span><br><span class="line"><span class="comment"># how often to check for server updates</span></span><br><span class="line"><span class="comment"># For format: https://linuxize.com/post/how-to-use-linux-sleep-command-to-pause-a-bash-script/</span></span><br><span class="line"><span class="keyword">ENV</span> VALHEIM_SERVER_AUTO_UPDATE_FREQUENCY <span class="string">&quot;30m&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">cd</span> <span class="variable">$&#123;STEAM_DIR&#125;</span> &amp;&amp; git <span class="built_in">clone</span> https://github.com/idelsink/b-log.git &amp;&amp; apt-get remove git -y &amp;&amp; <span class="built_in">chown</span> -R steam:steam b-log/</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># changes the uuid and guid to 1000:1000, allowing for the files to save on GNU/Linux</span></span><br><span class="line"><span class="keyword">USER</span> steam</span><br><span class="line"></span><br><span class="line"><span class="comment"># install the Valheim server</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> --<span class="built_in">chown</span>=steam dev/valheim-server <span class="variable">$&#123;VALHEIM_SERVER_DIR&#125;</span></span></span><br><span class="line"><span class="comment">#RUN ./steamcmd.sh +login anonymous \</span></span><br><span class="line"><span class="comment">#+force_install_dir $VALHEIM_SERVER_DIR \</span></span><br><span class="line"><span class="comment">#+app_update 896660 \</span></span><br><span class="line"><span class="comment">#validate +exit</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># where world data is stored, map this to the host directory where your worlds are stored</span></span><br><span class="line"><span class="comment"># e.g. docker run -v /path/to/host/directory:/home/steam/valheim-data</span></span><br><span class="line"><span class="keyword">ENV</span> VALHEIM_DATA_DIR <span class="string">&quot;/home/steam/valheim-data&quot;</span></span><br><span class="line"><span class="comment"># don&#x27;t change the port unless you know what you are doing</span></span><br><span class="line"><span class="keyword">ENV</span> VALHEIM_PORT <span class="number">2456</span></span><br><span class="line"><span class="comment"># server and world name are truncated after 1st white space</span></span><br><span class="line"><span class="comment"># you must set values to the server and world name otherwise the container will exit immediately</span></span><br><span class="line"><span class="keyword">ENV</span> VALHEIM_SERVER_NAME=<span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">ENV</span> VALHEIM_WORLD_NAME=<span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">ENV</span> VALHEIM_PASSWORD <span class="string">&quot;password&quot;</span></span><br><span class="line"><span class="comment"># 1 allows viewing the server in the public list; 0 hides it (must join by IP)</span></span><br><span class="line"><span class="keyword">ENV</span> VALHEIM_SERVER_PUBLIC <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># the server needs these 3 ports exposed by default</span></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">2456</span>/udp</span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">2457</span>/udp</span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">2458</span>/udp</span><br><span class="line"></span><br><span class="line"><span class="keyword">VOLUME</span><span class="language-bash"> <span class="variable">$&#123;VALHEIM_DATA_DIR&#125;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment"># copy over the scripts to start, update, and shutdown the server</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> --<span class="built_in">chown</span>=steam valheim-server-entrypoint.sh <span class="variable">$&#123;VALHEIM_SERVER_DIR&#125;</span></span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> --<span class="built_in">chown</span>=steam start-valheim-server.sh <span class="variable">$&#123;VALHEIM_SERVER_DIR&#125;</span></span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> --<span class="built_in">chown</span>=steam update-valheim-server.sh <span class="variable">$&#123;VALHEIM_SERVER_DIR&#125;</span></span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> --<span class="built_in">chown</span>=steam shutdown-valheim-server.sh <span class="variable">$&#123;VALHEIM_SERVER_DIR&#125;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> <span class="variable">$&#123;VALHEIM_SERVER_DIR&#125;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="language-bash"> [<span class="string">&quot;./valheim-server-entrypoint.sh&quot;</span>]</span></span><br></pre></td></tr></table></figure>

<p>Note we will still use the outdated server until we verify the automatic update behaves as expected, as done with <code>COPY --chown=steam dev/valheim-server $&#123;VALHEIM_SERVER_DIR&#125;</code>.  </p>
<h2 id="Testing-automatic-update"><a href="#Testing-automatic-update" class="headerlink" title="Testing automatic update"></a>Testing automatic update</h2><p>Rebuild the Docker image with the updated Dockerfile and scripts, e.g. <code>docker build -t valheim/auto-update -f Dockerfile --no-cache .</code>  Make sure the script files and the <code>dev/valheim-server</code> are in the current directory when building the image.</p>
<h3 id="Verify-it-automatically-updates"><a href="#Verify-it-automatically-updates" class="headerlink" title="Verify it automatically updates"></a>Verify it automatically updates</h3><ol>
<li><p>Run the image in a new container using these parameters:</p>
 <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker run --name=valheim-server -d \</span><br><span class="line">-p 2456:2456/udp -p 2457:2457/udp -p 2458:2458/udp \</span><br><span class="line">-v /home/sethmachine/valheim-data:/home/steam/valheim-data \</span><br><span class="line">--<span class="built_in">env</span> VALHEIM_SERVER_NAME=<span class="string">&quot;OutdatedServer&quot;</span> \</span><br><span class="line">--<span class="built_in">env</span> VALHEIM_WORLD_NAME=<span class="string">&quot;OutdatedWorld&quot;</span> \</span><br><span class="line">--<span class="built_in">env</span> VALHEIM_PASSWORD=<span class="string">&quot;HardToGuessPassword&quot;</span> \</span><br><span class="line">--<span class="built_in">env</span> VALHEIM_SERVER_UPDATE_ON_START_UP=0 \</span><br><span class="line">--<span class="built_in">env</span> VALHEIM_SERVER_AUTO_UPDATE=1 \</span><br><span class="line">--<span class="built_in">env</span> VALHEIM_SERVER_AUTO_UPDATE_FREQUENCY=10s \</span><br><span class="line">valheim/auto-update</span><br></pre></td></tr></table></figure>
<p> Note you will need to substitute the local worlds directory <code>/home/sethmachine/valheim-data</code> with an actual directory on your computer.  <code>VALHEIM_SERVER_UPDATE_ON_START_UP</code> is set to 0 so we can test the update loop.  <code>VALHEIM_SERVER_AUTO_UPDATE_FREQUENCY</code> is set to 10 seconds to give us time to tail log files right before the update happens.</p>
</li>
<li><p>Optionally, choose a longer frequency update such as 5 minutes (5m) and verify the server is outdated in the Valheim list.  Five minutes is chosen so the server can fully start and be listed on Valheim.  Attempting to join it should result in an error.   </p>
<p> <img src="/2021/05/21/automatic-update-for-valheim-server/valheim-server-outdated.png" alt="Outdated Valheim Server"></p>
</li>
<li><p>Tail the logs of the running container in a separate terminal, e.g. <code>docker logs -f valheim-server</code>.  You should see output like below (note yours may be colored differently):</p>
 <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[2021-05-15 15:11:26.426][WARN  ][main:51 ] Experimental auto update is enabled.  The server will automatically update and restart when a new version is detected</span><br><span class="line">[2021-05-15 15:11:26.429][INFO  ][main:52 ] Updates to the server will be checked every 10s</span><br><span class="line">[2021-05-15 15:11:26.432][INFO  ][main:57 ] Valheim server update loop PID is: 9</span><br><span class="line">[2021-05-15 15:11:26.432][INFO  ][startValheimServer:14 ] Starting the Valheim server</span><br><span class="line">[2021-05-15 15:11:26.435][INFO  ][startValheimServer:15 ] LD_LIBRARY_PATH: ./linux64:</span><br><span class="line">[2021-05-15 15:11:26.437][INFO  ][startValheimServer:17 ] Valheim port is: 2456</span><br><span class="line">[2021-05-15 15:11:26.440][INFO  ][startValheimServer:18 ] Valheim server name is: OutdatedServer</span><br><span class="line">[2021-05-15 15:11:26.442][INFO  ][startValheimServer:19 ] Valheim world name is: OutdatedWorld</span><br><span class="line">[2021-05-15 15:11:26.444][INFO  ][startValheimServer:24 ] The Valheim server is <span class="built_in">set</span> to public visibility.  It will be visible <span class="keyword">in</span> the server list.  Players will still need to enter the password to <span class="built_in">join</span></span><br><span class="line">[2021-05-15 15:11:26.446][INFO  ][startValheimServer:37 ] Valheim server PID is: 17</span><br><span class="line">[2021-05-15 15:11:26.448][INFO  ][startServerAndUpdateLoop:111] Sleeping <span class="keyword">for</span> 10s before checking <span class="keyword">for</span> Valheim server update</span><br></pre></td></tr></table></figure></li>
<li><p>After 10 seconds, the log output should begin to change and show the automatic update steps:</p>
 <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[2021-05-15 15:11:36.452][INFO  ][checkForAndUpdateValheimServer:89 ] Checking to see <span class="keyword">if</span> the Valheim server needs to be updated</span><br><span class="line">[2021-05-15 15:11:36.458][INFO  ][findAndSetLocalValheimServerBuildId:30 ] The <span class="built_in">local</span> build ID is 6315977</span><br><span class="line">[2021-05-15 15:11:36.461][INFO  ][findAndSetRemoteValheimServerBuildId:44 ] Querying the remote server <span class="keyword">for</span> the latest build ID <span class="keyword">for</span> the Valheim server</span><br><span class="line">[2021-05-15 15:11:57.070][INFO  ][findAndSetRemoteValheimServerBuildId:56 ] The remote server build ID is 6663905</span><br><span class="line">[2021-05-15 15:11:57.073][INFO  ][checkForAndUpdateValheimServer:96 ] Updating the Valheim server from 6315977 (old) to 6663905 (new)</span><br><span class="line">[2021-05-15 15:11:57.075][WARN  ][shutdownValheimServer:19 ] Shutting down the Valheim server.  PID is: 17</span><br><span class="line">[2021-05-15 15:12:01.043][INFO  ][updateValheimServer:69 ] Updating the Valheim server  </span><br></pre></td></tr></table></figure></li>
<li><p>The logs should then show Steam updating the server:</p>
 <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">WARNING: setlocale(<span class="string">&#x27;en_US.UTF-8&#x27;</span>) failed, using locale: <span class="string">&#x27;C&#x27;</span>. International characters may not work.</span><br><span class="line">Redirecting stderr to <span class="string">&#x27;/home/steam/Steam/logs/stderr.txt&#x27;</span></span><br><span class="line">[  0%] Checking <span class="keyword">for</span> available updates...</span><br><span class="line">[----] Verifying installation...</span><br><span class="line">Steam Console Client (c) Valve Corporation</span><br><span class="line">-- <span class="built_in">type</span> <span class="string">&#x27;quit&#x27;</span> to <span class="built_in">exit</span> --</span><br><span class="line">Loading Steam API...OK.</span><br><span class="line"></span><br><span class="line">Connecting anonymously to Steam Public...Logged <span class="keyword">in</span> OK</span><br><span class="line">Waiting <span class="keyword">for</span> user info...OK</span><br><span class="line"> Update state (0x3) reconfiguring, progress: 0.00 (0 / 0)</span><br><span class="line"> Update state (0x3) reconfiguring, progress: 0.00 (0 / 0)</span><br><span class="line"> Update state (0x61) downloading, progress: 0.11 (1048576 / 979372945)</span><br><span class="line"> Update state (0x61) downloading, progress: 5.85 (57256869 / 979372945)</span><br><span class="line"> Update state (0x61) downloading, progress: 87.31 (855081381 / 979372945)</span><br><span class="line"> Update state (0x61) downloading, progress: 94.83 (928751241 / 979372945)</span><br><span class="line"> Update state (0x61) downloading, progress: 98.07 (960498577 / 979372945)</span><br><span class="line"> Update state (0x61) downloading, progress: 99.79 (977275793 / 979372945)</span><br><span class="line"> Update state (0x101) committing, progress: 0.00 (0 / 979372945)</span><br><span class="line">Success! App <span class="string">&#x27;896660&#x27;</span> fully installed.    </span><br></pre></td></tr></table></figure></li>
<li><p>Finally, the server should start back up again.  It will still check for updates but since it is now up to date, nothing should happen:</p>
 <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[2021-05-15 15:12:20.379][INFO  ][findAndSetLocalValheimServerBuildId:28 ] The <span class="built_in">local</span> build ID was updated from 6315977 to 6663905</span><br><span class="line">[2021-05-15 15:12:20.384][INFO  ][assertLocalBuildIsLatest:64 ] The <span class="built_in">local</span> build ID is the same as the latest remote build ID</span><br><span class="line">[2021-05-15 15:12:20.390][INFO  ][startValheimServer:14 ] Starting the Valheim server</span><br><span class="line">[2021-05-15 15:12:20.393][INFO  ][startValheimServer:15 ] LD_LIBRARY_PATH: ./linux64:./linux64:</span><br><span class="line">[2021-05-15 15:12:20.398][INFO  ][startValheimServer:17 ] Valheim port is: 2456</span><br><span class="line">[2021-05-15 15:12:20.402][INFO  ][startValheimServer:18 ] Valheim server name is: OutdatedServer</span><br><span class="line">[2021-05-15 15:12:20.406][INFO  ][startValheimServer:19 ] Valheim world name is: OutdatedWorld</span><br><span class="line">[2021-05-15 15:12:20.409][INFO  ][startValheimServer:24 ] The Valheim server is <span class="built_in">set</span> to public visibility.  It will be visible <span class="keyword">in</span> the server list.  Players will still need to enter the password to <span class="built_in">join</span></span><br><span class="line">[2021-05-15 15:12:20.412][INFO  ][startValheimServer:37 ] Valheim server PID is: 164</span><br><span class="line">[2021-05-15 15:12:20.418][INFO  ][startServerAndUpdateLoop:111] Sleeping <span class="keyword">for</span> 10s before checking <span class="keyword">for</span> Valheim server update</span><br><span class="line">[2021-05-15 15:12:30.426][INFO  ][checkForAndUpdateValheimServer:89 ] Checking to see <span class="keyword">if</span> the Valheim server needs to be updated</span><br><span class="line">[2021-05-15 15:12:30.432][INFO  ][findAndSetLocalValheimServerBuildId:30 ] The <span class="built_in">local</span> build ID is 6663905</span><br><span class="line">[2021-05-15 15:12:30.435][INFO  ][findAndSetRemoteValheimServerBuildId:39 ] Deleting cached app info: /home/steam/Steam/appcache/appinfo.vdf</span><br><span class="line">[2021-05-15 15:12:30.440][INFO  ][findAndSetRemoteValheimServerBuildId:44 ] Querying the remote server <span class="keyword">for</span> the latest build ID <span class="keyword">for</span> the Valheim server</span><br><span class="line">[2021-05-15 15:12:35.529][INFO  ][findAndSetRemoteValheimServerBuildId:56 ] The remote server build ID is 6663905</span><br><span class="line">[2021-05-15 15:12:35.533][INFO  ][checkForAndUpdateValheimServer:94 ] The Valheim server is already up to <span class="built_in">date</span> with build ID 6663905</span><br></pre></td></tr></table></figure></li>
<li><p>Optionally, verify the server is updated in the list and attempt to join it once it has started up again.</p>
<p> <img src="/2021/05/21/automatic-update-for-valheim-server/valheim-server-after-auto-update.png" alt="Updated Valheim Server"></p>
</li>
<li><p>We should verify that the server stops gracefully after an update.  Run <code>docker stop valheim-server</code> and see this output:</p>
 <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[2021-05-15 15:14:53.989][INFO  ][terminateUpdateLoop:33 ] Terminating the update loop.  PID is 9</span><br><span class="line">[2021-05-15 15:14:53.993][WARN  ][shutdownValheimServerAndExit:7  ] Shutting down the Valheim server.  PID is: 164</span><br></pre></td></tr></table></figure></li>
<li><p>Inspect the exit code to make sure it is zero (a non-zero exit code would mean a problem): </p>
 <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">valheim-server-docker % docker inspect valheim-server --format=<span class="string">&#x27;&#123;&#123;.State.ExitCode&#125;&#125;&#x27;</span></span><br><span class="line">0</span><br></pre></td></tr></table></figure></li>
<li><p> Delete the container: <code>docker rm valheim-server</code></p>
</li>
</ol>
<p>If you observe similar output, it means the automatic update is working!   </p>
<h3 id="Verify-it-updates-on-start-up"><a href="#Verify-it-updates-on-start-up" class="headerlink" title="Verify it updates on start up"></a>Verify it updates on start up</h3><p>Each time the server is started up, we can check for update rather than wait on the loop to execute.  This is potentially faster, as the update is run before the server actually starts.  If it is updated on start up, we expect the update loop to not execute.  Updating on start up also allows for updating the server without rebuilding the Docker image.  </p>
<ol>
<li>Run the image in a new container using these parameters: <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker run --name=valheim-server -d \</span><br><span class="line">-p 2456:2456/udp -p 2457:2457/udp -p 2458:2458/udp \</span><br><span class="line">-v /home/sethmachine/valheim-data:/home/steam/valheim-data \</span><br><span class="line">--<span class="built_in">env</span> VALHEIM_SERVER_NAME=<span class="string">&quot;OutdatedServer&quot;</span> \</span><br><span class="line">--<span class="built_in">env</span> VALHEIM_WORLD_NAME=<span class="string">&quot;OutdatedWorld&quot;</span> \</span><br><span class="line">--<span class="built_in">env</span> VALHEIM_PASSWORD=<span class="string">&quot;HardToGuessPassword&quot;</span> \</span><br><span class="line">--<span class="built_in">env</span> VALHEIM_SERVER_UPDATE_ON_START_UP=1 \</span><br><span class="line">--<span class="built_in">env</span> VALHEIM_SERVER_AUTO_UPDATE=1 \</span><br><span class="line">--<span class="built_in">env</span> VALHEIM_SERVER_AUTO_UPDATE_FREQUENCY=10s \</span><br><span class="line">valheim/auto-update</span><br></pre></td></tr></table></figure></li>
<li>Tail the log files of the container, e.g. <code>docker logs -f valheim-server</code>.  Instead of starting the server, it should immediately begin performing an update, as shown below: <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[2021-05-16 00:39:05.678][INFO  ][main:28 ] Attempting one time update of the Valheim server on start up</span><br><span class="line">[2021-05-16 00:39:05.680][INFO  ][updateValheimServerIfNewerBuildExists:75 ] Checking to see <span class="keyword">if</span> the Valheim server needs to be updated</span><br><span class="line">[2021-05-16 00:39:05.686][INFO  ][findAndSetLocalValheimServerBuildId:30 ] The <span class="built_in">local</span> build ID is 6315977</span><br><span class="line">[2021-05-16 00:39:05.688][INFO  ][findAndSetRemoteValheimServerBuildId:44 ] Querying the remote server <span class="keyword">for</span> the latest build ID <span class="keyword">for</span> the Valheim server</span><br><span class="line">[2021-05-16 00:39:19.405][INFO  ][findAndSetRemoteValheimServerBuildId:56 ] The remote server build ID is 6663905</span><br><span class="line">[2021-05-16 00:39:19.408][INFO  ][updateValheimServer:69 ] Updating the Valheim server    </span><br></pre></td></tr></table></figure></li>
<li>Continue tailing the logs and verify that it the update loop does not update the server: <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[2021-05-16 00:39:39.660][WARN  ][main:51 ] Experimental auto update is enabled.  The server will automatically update and restart when a new version is detected</span><br><span class="line">[2021-05-16 00:39:39.664][INFO  ][main:52 ] Updates to the server will be checked every 10s</span><br><span class="line">[2021-05-16 00:39:39.667][INFO  ][startValheimServer:14 ] Starting the Valheim server</span><br><span class="line">[2021-05-16 00:39:39.667][INFO  ][main:57 ] Valheim server update loop PID is: 93</span><br><span class="line">[2021-05-16 00:39:39.671][INFO  ][startValheimServer:15 ] LD_LIBRARY_PATH: ./linux64:</span><br><span class="line">[2021-05-16 00:39:39.674][INFO  ][startValheimServer:17 ] Valheim port is: 2456</span><br><span class="line">[2021-05-16 00:39:39.676][INFO  ][startValheimServer:18 ] Valheim server name is: OutdatedServer</span><br><span class="line">[2021-05-16 00:39:39.679][INFO  ][startValheimServer:19 ] Valheim world name is: OutdatedWorld</span><br><span class="line">[2021-05-16 00:39:39.682][INFO  ][startValheimServer:24 ] The Valheim server is <span class="built_in">set</span> to public visibility.  It will be visible <span class="keyword">in</span> the server list.  Players will still need to enter the password to <span class="built_in">join</span></span><br><span class="line">[2021-05-16 00:39:39.686][INFO  ][startValheimServer:37 ] Valheim server PID is: 101</span><br><span class="line">[2021-05-16 00:39:39.690][INFO  ][startServerAndUpdateLoop:111] Sleeping <span class="keyword">for</span> 10s before checking <span class="keyword">for</span> Valheim server update</span><br><span class="line">[2021-05-16 00:39:49.662][INFO  ][checkForAndUpdateValheimServer:89 ] Checking to see <span class="keyword">if</span> the Valheim server needs to be updated</span><br><span class="line">[2021-05-16 00:39:49.667][INFO  ][findAndSetLocalValheimServerBuildId:28 ] The <span class="built_in">local</span> build ID was updated from 6315977 to 6663905</span><br><span class="line">[2021-05-16 00:39:49.670][INFO  ][findAndSetRemoteValheimServerBuildId:39 ] Deleting cached app info: /home/steam/Steam/appcache/appinfo.vdf</span><br><span class="line">[2021-05-16 00:39:49.674][INFO  ][findAndSetRemoteValheimServerBuildId:44 ] Querying the remote server <span class="keyword">for</span> the latest build ID <span class="keyword">for</span> the Valheim server</span><br><span class="line">[2021-05-16 00:39:54.476][INFO  ][findAndSetRemoteValheimServerBuildId:56 ] The remote server build ID is 6663905</span><br><span class="line">[2021-05-16 00:39:54.479][INFO  ][checkForAndUpdateValheimServer:94 ] The Valheim server is already up to <span class="built_in">date</span> with build ID 6663905</span><br></pre></td></tr></table></figure></li>
<li>Stop the container and verify the exit code is 0: <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">valheim-server-docker % docker stop valheim-server</span><br><span class="line">valheim-server</span><br><span class="line">valheim-server-docker % docker inspect valheim-server --format=<span class="string">&#x27;&#123;&#123;.State.ExitCode&#125;&#125;&#x27;</span></span><br><span class="line">0</span><br></pre></td></tr></table></figure></li>
<li> Delete the container: <code>docker rm valheim-server</code></li>
</ol>
<p>If you observe similar output, it means the update on startup feature is working as expected.   </p>
<h3 id="Verify-disabling-auto-update"><a href="#Verify-disabling-auto-update" class="headerlink" title="Verify disabling auto update"></a>Verify disabling auto update</h3><p>This is to confirm that the server still works if automatic update is turned off.  Turning off automatic update may be useful if you want to run a specific version of the Valheim server, or otherwise want to control when updates happen.  In most cases for a server running 24/7, keeping automatic update on is recommended.</p>
<ol>
<li>Run the image in a new container using these parameters: <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker run --name=valheim-server -d \</span><br><span class="line">-p 2456:2456/udp -p 2457:2457/udp -p 2458:2458/udp \</span><br><span class="line">-v /home/sethmachine/valheim-data:/home/steam/valheim-data \</span><br><span class="line">--<span class="built_in">env</span> VALHEIM_SERVER_NAME=<span class="string">&quot;OutdatedServer&quot;</span> \</span><br><span class="line">--<span class="built_in">env</span> VALHEIM_WORLD_NAME=<span class="string">&quot;OutdatedWorld&quot;</span> \</span><br><span class="line">--<span class="built_in">env</span> VALHEIM_PASSWORD=<span class="string">&quot;HardToGuessPassword&quot;</span> \</span><br><span class="line">--<span class="built_in">env</span> VALHEIM_SERVER_UPDATE_ON_START_UP=0 \</span><br><span class="line">--<span class="built_in">env</span> VALHEIM_SERVER_AUTO_UPDATE=0 \</span><br><span class="line">--<span class="built_in">env</span> VALHEIM_SERVER_AUTO_UPDATE_FREQUENCY=10s \</span><br><span class="line">valheim/auto-update</span><br></pre></td></tr></table></figure></li>
<li>Tail the logs and verify the server starts but does not update with <code>docker logs -f valheim-server</code>.   <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[2021-05-16 00:47:10.197][INFO  ][startValheimServer:14 ] Starting the Valheim server</span><br><span class="line">[2021-05-16 00:47:10.200][INFO  ][startValheimServer:15 ] LD_LIBRARY_PATH: ./linux64:</span><br><span class="line">[2021-05-16 00:47:10.205][INFO  ][startValheimServer:17 ] Valheim port is: 2456</span><br><span class="line">[2021-05-16 00:47:10.208][INFO  ][startValheimServer:18 ] Valheim server name is: OutdatedServer</span><br><span class="line">[2021-05-16 00:47:10.210][INFO  ][startValheimServer:19 ] Valheim world name is: OutdatedWorld</span><br><span class="line">[2021-05-16 00:47:10.212][INFO  ][startValheimServer:24 ] The Valheim server is <span class="built_in">set</span> to public visibility.  It will be visible <span class="keyword">in</span> the server list.  Players will still need to enter the password to <span class="built_in">join</span></span><br><span class="line">[2021-05-16 00:47:10.214][INFO  ][startValheimServer:37 ] Valheim server PID is: 14</span><br></pre></td></tr></table></figure></li>
<li>Wait for the Valheim server to finish starting up.  Then stop the container and verify the exit code is 0: <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">valheim-server-docker % docker stop valheim-server</span><br><span class="line">valheim-server</span><br><span class="line">valheim-server-docker % docker inspect valheim-server --format=<span class="string">&#x27;&#123;&#123;.State.ExitCode&#125;&#125;&#x27;</span></span><br><span class="line">0</span><br></pre></td></tr></table></figure></li>
<li> Delete the container: <code>docker rm valheim-server</code></li>
</ol>
<p>Be sure to wait for the server to fully start up before stopping the container, otherwise you may see a non-zero exit code.  </p>
<h2 id="Usage"><a href="#Usage" class="headerlink" title="Usage"></a>Usage</h2><p>The automatic update feature removes the need to keep rebuilding the Docker image whenever Valheim has an update, since it will update itself within the container.  This means even if the Docker image’s Valheim server is out of date, the container will run at the latest version once the update has completed.  Further, if the container is stopped, it will continue to use the updated Valheim server when started up again.  However, if the container is deleted, then it may go through updates if the Docker image uses an older version of the server.  Existing worlds can continue to be used without issue as long as the right worlds directory is chosen when starting the container.  </p>
<p>You’ll first start the server like this:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker run --name=valheim-server -d \</span><br><span class="line">--restart always \</span><br><span class="line">-p 2456:2456/udp -p 2457:2457/udp -p 2458:2458/udp \</span><br><span class="line">-v /home/sethmachine/valheim-data:/home/steam/valheim-data \</span><br><span class="line">--<span class="built_in">env</span> VALHEIM_SERVER_NAME=<span class="string">&quot;OutdatedServer&quot;</span> \</span><br><span class="line">--<span class="built_in">env</span> VALHEIM_WORLD_NAME=<span class="string">&quot;OutdatedWorld&quot;</span> \</span><br><span class="line">--<span class="built_in">env</span> VALHEIM_PASSWORD=<span class="string">&quot;HardToGuessPassword&quot;</span> \</span><br><span class="line">--<span class="built_in">env</span> VALHEIM_PUBLIC=1 \</span><br><span class="line">--<span class="built_in">env</span> VALHEIM_SERVER_UPDATE_ON_START_UP=1 \</span><br><span class="line">--<span class="built_in">env</span> VALHEIM_SERVER_AUTO_UPDATE=1 \</span><br><span class="line">--<span class="built_in">env</span> VALHEIM_SERVER_AUTO_UPDATE_FREQUENCY=30m \</span><br><span class="line">valheim/auto-update</span><br></pre></td></tr></table></figure>

<p>At some point the server will stop itself, update, and restart when a new update comes in.  If ever the server is stopped (either you shut it down manually or the host machine was turned off unexpectedly), the container itself will still exist and have the updated server.  Simply start it up again with <code>docker start valheim-server</code> (or however the container is named) and it should be up to date.  </p>
<p>If you need to execute a manual update sooner than the auto update, simple stop the container and then start it again.  Make sure <code>VALHEIM_SERVER_UPDATE_ON_START_UP</code> is set to 1.  Starting it again will trigger a check for an update immediately.  </p>
<h2 id="Final-thoughts"><a href="#Final-thoughts" class="headerlink" title="Final thoughts"></a>Final thoughts</h2><p>We were able to create a system for automatically updating a Valheim server to enable running it truly 24/7 unsupervised.  We organized the different functions of starting, stopping, and updating the Valheim server into separate script files to handle the added complexity of automatic update.  We also examined how to forward signals through multiple processes with Bash.  </p>
<p>The automatic update Docker image is available on Docker Hub and the corresponding Dockerfile and scripts on GitHub:</p>
<ul>
<li>Docker Hub: <a target="_blank" rel="noopener" href="https://hub.docker.com/r/sethmachineio/valheim-server">sethmachineio/valheim-server</a></li>
<li>GitHub: <a target="_blank" rel="noopener" href="https://github.com/sethmachine/valheim-server-docker">valheim-server-docker</a></li>
</ul>
<p>Feel free to leave a comment if you found this helpful, have any feedback, or are stuck on any parts of this guide.  I’ll do my best to respond and help you!  </p>

      </div>
      
        <div class="prev-or-next">
          <div class="post-foot-next">
            
              <a href="/2021/02/11/host-valheim-with-docker/" target="_self">
                <i class="iconfont icon-chevronleft"></i>
                <span>Prev</span>
              </a>
            
          </div>
          <div class="post-attach">
            <span class="post-pubtime">
              <i class="iconfont icon-updatetime mr-10" title="Update time"></i>
              2022-12-08 10:38:15
            </span>
            
                  <span class="post-tags">
                    <i class="iconfont icon-tags mr-10" title="Tags"></i>
                    
                    <span class="span--tag mr-8">
                      <a href="/tags/Docker/" title="Docker">
                        #Docker
                      </a>
                    </span>
                    
                    <span class="span--tag mr-8">
                      <a href="/tags/Valheim/" title="Valheim">
                        #Valheim
                      </a>
                    </span>
                    
                    <span class="span--tag mr-8">
                      <a href="/tags/Steam/" title="Steam">
                        #Steam
                      </a>
                    </span>
                    
                    <span class="span--tag mr-8">
                      <a href="/tags/Dedicated-Server/" title="Dedicated Server">
                        #Dedicated Server
                      </a>
                    </span>
                    
                    <span class="span--tag mr-8">
                      <a href="/tags/Bash/" title="Bash">
                        #Bash
                      </a>
                    </span>
                    
                  </span>
              
          </div>
          <div class="post-foot-prev">
            
              <a href="/2022/05/17/universal-sound-board/" target="_self">
                <span>Next</span>
                <i class="iconfont icon-chevronright"></i>
              </a>
            
          </div>
        </div>
      
    </div>
    
  <div id="btn-catalog" class="btn-catalog">
    <i class="iconfont icon-catalog"></i>
  </div>
  <div class="post-catalog hidden" id="catalog">
    <div class="title">Contents</div>
    <div class="catalog-content">
      
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Introduction"><span class="toc-text">Introduction</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Why-automatic-update"><span class="toc-text">Why automatic update</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#The-challenge-of-automatic-update"><span class="toc-text">The challenge of automatic update</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Steps-for-automatic-update"><span class="toc-text">Steps for automatic update</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Environment-for-testing"><span class="toc-text">Environment for testing</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Logging"><span class="toc-text">Logging</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Set-up-outdated-server"><span class="toc-text">Set up outdated server</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Detect-server-updates"><span class="toc-text">Detect server updates</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Find-local-build-ID"><span class="toc-text">Find local build ID</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Find-remote-build-ID"><span class="toc-text">Find remote build ID</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Compare-build-IDs"><span class="toc-text">Compare build IDs</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#The-update-loop"><span class="toc-text">The update loop</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#start-valheim-server-sh"><span class="toc-text">start-valheim-server.sh</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#shutdown-valheim-server-sh"><span class="toc-text">shutdown-valheim-server.sh</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#update-valheim-server-sh"><span class="toc-text">update-valheim-server.sh</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#valheim-server-entrypoint-sh"><span class="toc-text">valheim-server-entrypoint.sh</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-it-all-works"><span class="toc-text">How it all works</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Updated-Dockerfile"><span class="toc-text">Updated Dockerfile</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Testing-automatic-update"><span class="toc-text">Testing automatic update</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Verify-it-automatically-updates"><span class="toc-text">Verify it automatically updates</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Verify-it-updates-on-start-up"><span class="toc-text">Verify it updates on start up</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Verify-disabling-auto-update"><span class="toc-text">Verify disabling auto update</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Usage"><span class="toc-text">Usage</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Final-thoughts"><span class="toc-text">Final thoughts</span></a></li></ol>
      
    </div>
  </div>

  
<script src="/js/catalog.js"></script>




    
      <div class="comments-container">
        


  <div id="disqus_thread"></div>
  <script>
    /**
    *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
    *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
    /*
    var disqus_config = function () {
    this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
    this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
    */
    (function() { // DON'T EDIT BELOW THIS LINE
    var d = document, s = d.createElement('script');
    s.src = 'https://sethmachine01.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
    })();
  </script>
  <noscript>Please enable JavaScript to view the <a target="_blank" rel="noopener" href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>






      </div>
    
  </div>


        
<div class="footer">
  <div class="social">
    <ul>
      
        <li>
          
              <a title="github" target="_blank" rel="noopener" href="https://github.com/sethmachine">
                <i class="iconfont icon-github"></i>
              </a>
              
        </li>
        
        <li>
          
            <a title="email" href="mailto:sdworman@brandeis.edu">
              <i class="iconfont icon-envelope"></i>
            </a>
            
        </li>
        
    </ul>
  </div>
  
    
    <div class="footer-more">
      
        <a target="_blank" rel="noopener" href="https://github.com/zchengsite/hexo-theme-oranges">Copyright © sethmachine 2025</a>
        
    </div>
  
    
    <div class="footer-more">
      
        <a target="_blank" rel="noopener" href="https://github.com/zchengsite/hexo-theme-oranges">Theme by Oranges | Powered by Hexo</a>
        
    </div>
  
    
    <div class="footer-more">
      
        <a target="_blank" rel="noopener" href="https://icons8.com/icons/set/espresso-cup">Espresso Cup icon by Icons8</a>
        
    </div>
  
  
</div>

      </div>

      <div class="tools-bar">
        <div class="back-to-top tools-bar-item hidden">
  <a href="javascript: void(0)">
    <i class="iconfont icon-chevronup"></i>
  </a>
</div>


<script src="/js/backtotop.js"></script>



        


        
  <div class="tools-bar-item theme-icon" id="switch-color-scheme">
    <a href="javascript: void(0)">
      <i id="theme-icon" class="iconfont icon-moon"></i>
    </a>
  </div>

  
<script src="/js/colorscheme.js"></script>





        
  
    <div class="share-icon tools-bar-item">
      <a href="javascript: void(0)" id="share-icon">
        <i class="iconfont iconshare"></i>
      </a>
      <div class="share-content hidden">
        
          <a class="share-item" href="https://twitter.com/intent/tweet?text=' + Automatic%20Update%20for%20Valheim%20Server + '&url=' + http%3A%2F%2Fexample.com%2F2021%2F05%2F21%2Fautomatic-update-for-valheim-server%2F + '" target="_blank" title="Twitter">
            <i class="iconfont icon-twitter"></i>
          </a>
        
        
          <a class="share-item" href="https://www.facebook.com/sharer.php?u=http://example.com/2021/05/21/automatic-update-for-valheim-server/" target="_blank" title="Facebook">
            <i class="iconfont icon-facebooksquare"></i>
          </a>
        
      </div>
    </div>
  
  
<script src="/js/shares.js"></script>



      </div>
    </div>
  </body>
</html>
